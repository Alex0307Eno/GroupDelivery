@model IEnumerable<GroupDelivery.Domain.StoreMenuItem>

@{
    ViewData["Title"] = "菜單管理";
    var storeId = (int)ViewBag.StoreId;
}

<style>
    .page-wrapper {
        max-width: 1100px;
        margin: 50px auto;
    }

    .header-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
    }

    .menu-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill,minmax(320px,1fr));
        gap: 24px;
    }

    .menu-card {
        background: #fff;
        border-radius: 18px;
        box-shadow: 0 10px 30px rgba(0,0,0,.06);
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }

    .menu-image {
        height: 180px;
        background: #f3f4f6;
        display: flex;
        align-items: center;
        justify-content: center;
    }

        .menu-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

    .menu-body {
        padding: 20px;
        flex: 1;
    }

    .menu-name {
        font-weight: 700;
        font-size: 18px;
        margin-bottom: 6px;
    }

    .menu-price {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 8px;
    }

    .menu-description {
        font-size: 13px;
        color: #666;
        margin-bottom: 12px;
        min-height: 40px;
    }

    /* 客製化顯示 */

    .option-section {
        border-top: 1px solid #f0f0f0;
        padding-top: 10px;
        margin-top: 10px;
    }

    .option-group-title {
        font-size: 12px;
        font-weight: 600;
        margin-bottom: 4px;
        color: #444;
    }

    .option-list {
        font-size: 12px;
        color: #666;
        margin-bottom: 6px;
    }

    .menu-footer {
        padding: 16px 20px;
        border-top: 1px solid #f0f0f0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .status-badge {
        font-size: 12px;
        padding: 4px 10px;
        border-radius: 999px;
    }

    .status-on {
        background: #e6f4ea;
        color: #1e7e34;
    }

    .status-off {
        background: #f2f2f2;
        color: #666;
    }

    .action-buttons {
        display: flex;
        gap: 6px;
    }

    .btn-sm {
        font-size: 12px;
        padding: 6px 10px;
        border-radius: 999px;
    }
</style>

<div class="page-wrapper">

    <div class="header-row">
        <h3 class="fw-bold mb-0">菜單管理</h3>

        <a href="/StoreMenu/BatchCreate/@storeId"
           class="btn btn-primary">
            + 新增品項
        </a>
    </div>

    @if (!Model.Any())
    {
        <div class="alert alert-light text-center py-5">
            <div class="fw-bold mb-2">目前還沒有任何品項</div>
            <div class="text-muted mb-3">
                新增菜單後，消費者才能點餐
            </div>

            <a class="btn btn-success"
               href="/StoreMenu/BatchCreate/@storeId">
                新增第一個品項
            </a>
        </div>
    }
    else
    {
        <div class="menu-grid">

            @foreach (var item in Model)
            {
                <div class="menu-card">

                    <div class="menu-image">
                        @if (!string.IsNullOrEmpty(item.ImageUrl))
                        {
                            <img src="@item.ImageUrl" />
                        }
                        else
                        {
                            <span class="text-muted">無圖片</span>
                        }
                    </div>

                    <div class="menu-body">

                        <div class="menu-name">
                            @item.Name
                        </div>

                        <div class="menu-price">
                            $@item.Price.ToString("0.0")
                        </div>

                        <div class="menu-description">
                            @item.Description
                        </div>

                        <!-- 客製化顯示 -->
                        <div class="option-section">

                            @if (item.OptionGroups != null && item.OptionGroups.Any())
                            {
                                foreach (var group in item.OptionGroups)
                                {
                                    <div class="option-group-title">
                                        @group.GroupName
                                    </div>

                                    <div class="option-list">
                                        @foreach (var option in group.Options)
                                        {
                                            <span>
                                                @option.OptionName
                                                @if (option.PriceAdjust > 0)
                                                {
                                                    <text>(+$@option.PriceAdjust.ToString("0.0"))</text>
                                                }
                                            </span>
                                            @if (option != group.Options.Last())
                                            {
                                                <text>、</text>
                                            }
                                        }
                                    </div>
                                }
                            }
                            else
                            {
                                <div class="option-list text-muted">
                                    無客製化選項
                                </div>
                            }

                        </div>

                    </div>

                    <div class="menu-footer">

                        <div>
                            @if (item.IsActive)
                            {
                                <span class="status-badge status-on">
                                    上架中
                                </span>
                            }
                            else
                            {
                                <span class="status-badge status-off">
                                    已下架
                                </span>
                            }
                        </div>

                        <div class="action-buttons">

                            <a class="btn btn-outline-primary btn-sm"
                               href="/StoreMenu/edit/@item.StoreMenuItemId">
                                編輯
                            </a>

                            <button type="button"
                                    class="btn btn-outline-warning btn-sm toggle-menu-btn"
                                    data-id="@item.StoreMenuItemId">
                                @(item.IsActive ? "下架" : "上架")
                            </button>

                            <button type="button"
                                    class="btn btn-outline-danger btn-sm delete-menu-btn"
                                    data-id="@item.StoreMenuItemId">
                                刪除
                            </button>

                        </div>

                    </div>

                </div>
            }

        </div>
    }

</div>
<script>
        document.addEventListener("DOMContentLoaded", function () {

        document.querySelectorAll(".toggle-menu-btn").forEach(function (btn) {

            btn.addEventListener("click", function () {

                var id = btn.dataset.id;
                if (!id) return;

                fetch("/api/storemenu/toggle", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ id: parseInt(id) })
                })
                .then(function (res) {
                    if (!res.ok) throw new Error();

                    var card = btn.closest(".menu-card");
                    var badge = card.querySelector(".status-badge");

                    var isActive = badge.classList.contains("status-on");
                    var newActive = !isActive;

                    // 更新按鈕文字
                    btn.textContent = newActive ? "下架" : "上架";

                    // 更新 badge
                    if (newActive) {
                        badge.textContent = "上架中";
                        badge.classList.remove("status-off");
                        badge.classList.add("status-on");
                    } else {
                        badge.textContent = "已下架";
                        badge.classList.remove("status-on");
                        badge.classList.add("status-off");
                    }

                    // 更新按鈕樣式
                    btn.classList.remove("btn-outline-warning", "btn-outline-success");
                    btn.classList.add(newActive ? "btn-outline-warning" : "btn-outline-success");

                })
                .catch(function () {
                    alert("切換失敗，請稍後再試");
                });

            });

        });

    });
</script>