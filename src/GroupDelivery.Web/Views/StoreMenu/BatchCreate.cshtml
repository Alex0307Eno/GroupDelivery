@model int

@{
    var storeId = Model;
}

<div id="app" class="container py-5">

    <!-- 頁首 -->
    <div class="text-center mb-5">
        <h2 class="fw-bold mb-2">建立你的菜單</h2>
        <p class="text-muted mb-0">讓顧客一打開頁面就知道要點什麼</p>
    </div>

    <div class="row g-4">

        <!-- 左側：封面＋目前菜單預覽 -->
        <div class="col-lg-5">

            <!-- 菜單封面圖片 -->
            <div class="card shadow-sm p-4 mb-4 menu-card">
                <h5 class="fw-bold mb-3">菜單封面</h5>

                <input type="file"
                       class="form-control mb-3"
                       accept="image/*"
                       @@change="onFileChange" />

                <div v-if="previewUrl || storeCoverUrl" class="text-center">
                    <img :src="previewUrl || storeCoverUrl"
                         class="img-fluid rounded shadow-sm"
                         style="max-height:260px; object-fit: cover; width:100%;" />
                </div>

                <p v-else class="text-muted small mb-0">
                    尚未上傳封面圖片，建議使用橫式、清晰的餐點或店內照片。
                </p>
            </div>

            <!-- 目前菜單預覽 -->
            <div class="card shadow-sm p-4 menu-card">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h5 class="fw-bold mb-0">目前菜單</h5>
                    <span class="badge bg-light text-muted border">
                        共 {{ existingMenu.length }} 項
                    </span>
                </div>

                <div v-if="existingMenu.length === 0">
                    <p class="text-muted mb-0">
                        還沒有任何菜單品項，右邊先新增幾個之後就會顯示在這裡。
                    </p>
                </div>

                <div v-else class="menu-preview">

                    <div v-for="cat in categories"
                         :key="'preview-' + cat.storeMenuCategoryId"
                         class="mb-3">

                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <h6 class="fw-bold mb-0">
                                {{ cat.name }}
                            </h6>
                            <span class="text-muted small">
                                {{ countExistingByCategory(cat.storeMenuCategoryId) }} 項
                            </span>
                        </div>

                        <div v-if="filteredExistingByCategory(cat.storeMenuCategoryId).length === 0">
                            <p class="text-muted small mb-0">此分類尚無品項。</p>
                        </div>

                        <ul v-else class="list-group list-group-flush menu-preview-list">
                            <li class="list-group-item px-0 py-2 d-flex justify-content-between align-items-center"
                                v-for="m in filteredExistingByCategory(cat.storeMenuCategoryId)"
                                :key="m.storeMenuItemId">

                                <div class="me-2">
                                    <div class="fw-semibold">{{ m.name }}</div>
                                    <div v-if="m.description"
                                         class="text-muted xsmall">
                                        {{ m.description }}
                                    </div>
                                </div>

                                <div class="fw-bold text-end">
                                    {{ m.price }} 元
                                </div>
                            </li>
                        </ul>
                    </div>
                </div>

            </div>

        </div>

        <!-- 右側：分類管理＋批量新增 -->
        <div class="col-lg-7">

            <!-- 分類管理 -->
            <div class="card shadow-sm p-4 mb-4 menu-card">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                        <h5 class="fw-bold mb-1">分類管理</h5>
                        <div class="text-muted small">
                            例如：主食、飲料、小菜、甜點
                        </div>
                    </div>
                </div>

                <div class="input-group mb-3">
                    <input v-model="newCategoryName"
                           class="form-control"
                           placeholder="輸入分類名稱，例如：主食" />
                    <button class="btn btn-dark"
                            type="button"
                            @@click="createCategory">
                        新增分類
                    </button>
                </div>

                <div v-if="categories.length > 0" class="d-flex flex-wrap gap-2">
                    <div class="category-chip"
                         v-for="c in categories"
                         :key="c.storeMenuCategoryId">
                        <span class="category-dot"></span>
                        <span class="category-name">{{ c.name }}</span>
                        <span class="category-count"
                              v-if="countExistingByCategory(c.storeMenuCategoryId) > 0">
                            · {{ countExistingByCategory(c.storeMenuCategoryId) }} 項
                        </span>
                    </div>
                </div>

                <p v-else class="text-muted small mb-0">
                    尚未建立任何分類，先新增一個「主食」當作第一個分類。
                </p>
            </div>

            <!-- 菜單品項（批量新增草稿） -->
            <div class="card shadow-sm p-4 menu-card">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="fw-bold mb-0">批量新增品項</h5>
                    <span class="text-muted small">
                        建議先選好分類，再輸入名稱與價格
                    </span>
                </div>

                <div class="row g-4">

                    <div class="col-md-6"
                         v-for="(item,index) in items"
                         :key="index">

                        <div class="card h-100 shadow-sm menu-item-editor">
                            <div class="card-body">

                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="badge bg-dark-subtle text-dark small">
                                        新品項 {{ index + 1 }}
                                    </span>

                                    <button class="btn btn-sm btn-outline-secondary"
                                            type="button"
                                            @@click="remove(index)">
                                        移除
                                    </button>
                                </div>

                                <!-- 分類 -->
                                <div class="mb-2">
                                    <label class="form-label xsmall text-muted">
                                        分類
                                    </label>

                                    <select v-model.number="item.categoryId"
                                            class="form-select form-select-sm">
                                        <option value="">請選擇分類</option>
                                        <option v-for="c in categories"
                                                :key="c.storeMenuCategoryId"
                                                :value="c.storeMenuCategoryId">
                                            {{ c.name }}
                                        </option>
                                    </select>
                                </div>

                                <!-- 名稱 -->
                                <div class="mb-2">
                                    <label class="form-label xsmall text-muted">
                                        名稱
                                    </label>
                                    <input v-model="item.name"
                                           class="form-control form-control-sm"
                                           placeholder="例如：雞肉飯" />
                                </div>

                                <!-- 價格 -->
                                <div class="mb-2">
                                    <label class="form-label xsmall text-muted">
                                        價格（元）
                                    </label>
                                    <input v-model.number="item.price"
                                           type="number"
                                           class="form-control form-control-sm"
                                           min="0"
                                           placeholder="70" />
                                </div>

                                <!-- 說明 -->
                                <div>
                                    <label class="form-label xsmall text-muted">
                                        說明（可略）
                                    </label>
                                    <textarea v-model="item.description"
                                              class="form-control form-control-sm"
                                              rows="2"
                                              placeholder="例如：附湯、可加辣、不加蔥請備註"></textarea>
                                </div>

                            </div>
                        </div>
                    </div>

                </div>

                <!-- 新增品項按鈕 -->
                <div class="d-flex justify-content-between align-items-center mt-4">
                    <button class="btn btn-outline-dark"
                            type="button"
                            @@click="addRow">
                        ＋ 再新增一個品項
                    </button>

                    <button class="btn btn-success px-4"
                            type="button"
                            @@click="submit">
                        儲存全部菜單
                    </button>
                </div>

            </div>

        </div>

    </div>

</div>

<style>
    body {
        background: radial-gradient(circle at top, #fdf7ec 0, #f5f7fb 40%, #edf0ff 100%);
    }

    .menu-card {
        border-radius: 16px;
        border: 0;
        box-shadow: 0 18px 40px rgba(15, 23, 42, 0.06);
    }

    .menu-item-editor {
        border-radius: 12px;
        border: 0;
        box-shadow: 0 10px 25px rgba(15, 23, 42, 0.05);
    }

    .menu-preview {
        max-height: 420px;
        overflow-y: auto;
    }

    .menu-preview-list .list-group-item {
        border: 0;
        border-bottom: 1px solid rgba(0,0,0,0.04);
    }

        .menu-preview-list .list-group-item:last-child {
            border-bottom: 0;
        }

    .xsmall {
        font-size: 0.78rem;
    }

    .category-chip {
        display: inline-flex;
        align-items: center;
        padding: 4px 10px;
        border-radius: 999px;
        background-color: #f3f4f6;
        font-size: 0.78rem;
        color: #374151;
    }

    .category-dot {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background-color: #4b5563;
        margin-right: 6px;
    }

    .category-name {
        font-weight: 600;
    }

    .category-count {
        margin-left: 6px;
        color: #9ca3af;
    }

    .btn-dark-subtle {
        background-color: #1118270d;
        border-color: #1118271a;
    }
</style>

<script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<script>
    const { createApp } = Vue;

    createApp({

        data() {
            return {
                storeId: @storeId,
                categories: [],
                newCategoryName: '',
                items: [
                    { name: '', price: 0, description: '', categoryId: null }
                ],
                existingMenu: [],
                menuImage: null,
                previewUrl: null,
                storeCoverUrl: null   // 若後端有傳店家原本封面，可以之後再補
            };
        },

        mounted() {
            this.loadCategories();
            this.loadExistingMenu();
         
        },

        methods: {

            loadCategories() {
                axios.get(`/api/storemenu/categories/${this.storeId}`)
                    .then(res => {
                        this.categories = res.data || [];
                    })
                    .catch(err => {
                        console.error(err);
                    });
            },

            loadExistingMenu() {
                axios.get(`/api/storemenu/list/${this.storeId}`)
                    .then(res => {
                        this.existingMenu = res.data || [];
                    })
                    .catch(err => {
                        console.error(err);
                    });
            },

            filteredExistingByCategory(categoryId) {
                return this.existingMenu.filter(function (x) {
                    return x.categoryId === categoryId;
                });
            },

            countExistingByCategory(categoryId) {
                return this.existingMenu.filter(function (x) {
                    return x.categoryId === categoryId;
                }).length;
            },

            createCategory() {

                if (!this.newCategoryName || this.newCategoryName.trim() === '') {
                    alert("請輸入分類名稱");
                    return;
                }

                axios.post('/api/storemenu/category', {
                    storeId: this.storeId,
                    name: this.newCategoryName
                })
                    .then(() => {
                        this.newCategoryName = '';
                        this.loadCategories();
                    })
                    .catch(err => {
                        console.error(err);
                        alert("新增分類失敗");
                    });
            },

            addRow() {
                this.items.push({
                    name: '',
                    price: 0,
                    description: '',
                    categoryId: null
                });
            },

            remove(index) {
                this.items.splice(index, 1);
            },

            onFileChange(e) {
                const file = e.target.files[0];
                if (!file) return;

                this.menuImage = file;
                this.previewUrl = URL.createObjectURL(file);
            },

            submit() {

                const validItems = this.items.filter(function (x) {
                    return x.name &&
                        x.name.trim() !== '' &&
                        x.categoryId;
                });

                if (validItems.length === 0) {
                    alert("請至少填寫一個有名稱且有分類的品項");
                    return;
                }

                const formData = new FormData();
                formData.append("storeId", this.storeId);
                formData.append("items", JSON.stringify(validItems));

                if (this.menuImage) {
                    formData.append("menuImage", this.menuImage);
                }

                axios.post('/api/storemenu/batchcreate', formData)
                    .then(() => {
                        this.items = [
                            { name: '', price: 0, description: '', categoryId: null }
                        ];
                        this.loadExistingMenu();
                        this.menuImage = null;
                        // 不清 previewUrl，讓封面維持顯示
                        alert("菜單已更新");
                    })
                    .catch(err => {
                        console.error(err);
                        alert("儲存失敗");
                    });
            }
        }

    }).mount('#app');
</script>