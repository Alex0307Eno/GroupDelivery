@model int

@{
    var storeId = Model;
}

<div id="app" class="container py-5">

    <div class="text-center mb-5">
        <h2 class="fw-bold mb-2">建立你的菜單</h2>
        <p class="text-muted mb-0">完整支援圖片與客製選項</p>
    </div>

    <div class="row g-4">

        <!-- 左側 -->
        <div class="col-lg-5">

            <!-- 封面 -->
            <div class="card shadow-sm p-4 mb-4 menu-card">
                <h5 class="fw-bold mb-3">菜單封面</h5>

                <input type="file"
                       class="form-control mb-3"
                       accept="image/*"
                       @@change="onCoverChange" />

                <img v-if="coverPreview"
                     :src="coverPreview"
                     class="img-fluid rounded"
                     style="max-height:260px; object-fit:cover;width:100%;" />
            </div>

            <!-- 現有菜單 -->
            <div class="card shadow-sm p-4 menu-card">
                <h5 class="fw-bold mb-3">目前菜單</h5>

                <div v-if="existingMenu.length === 0"
                     class="text-muted">
                    尚無品項
                </div>

                <ul v-else class="list-group list-group-flush">
                    <li v-for="m in existingMenu"
                        :key="m.storeMenuItemId"
                        class="list-group-item d-flex justify-content-between">

                        <div>
                            <div class="fw-semibold">{{ m.name }}</div>
                            <div class="small text-muted">
                                {{ m.description }}
                            </div>
                        </div>

                        <div class="fw-bold">
                            {{ m.price }} 元
                        </div>
                    </li>
                </ul>
            </div>

        </div>

        <!-- 右側 -->
        <div class="col-lg-7">

            <!-- 分類 -->
            <div class="card shadow-sm p-4 mb-4 menu-card">

                <h5 class="fw-bold mb-3">分類管理</h5>

                <div class="input-group mb-3">
                    <input v-model="newCategoryName"
                           class="form-control"
                           placeholder="輸入分類名稱" />
                    <button class="btn btn-dark"
                            @@click="createCategory">
                        新增
                    </button>
                </div>

                <div class="d-flex flex-wrap gap-2">
                    <span v-for="c in categories"
                          :key="c.storeMenuCategoryId"
                          class="badge bg-light text-dark border">
                        {{ c.name }}
                    </span>
                </div>

            </div>

            <!-- 新增品項 -->
            <div class="card shadow-sm p-4 menu-card">

                <h5 class="fw-bold mb-4">新增品項</h5>

                <div v-for="(item,index) in items"
                     :key="index"
                     class="border rounded p-3 mb-4">

                    <div class="d-flex justify-content-between mb-2">
                        <strong>品項 {{ index + 1 }}</strong>
                        <button class="btn btn-sm btn-outline-danger"
                                @@click="remove(index)">
                            刪除
                        </button>
                    </div>

                    <!-- 分類 -->
                    <select v-model.number="item.categoryId"
                            class="form-select mb-2">
                        <option value="">選擇分類</option>
                        <option v-for="c in categories"
                                :value="c.storeMenuCategoryId">
                            {{ c.name }}
                        </option>
                    </select>

                    <input v-model="item.name"
                           class="form-control mb-2"
                           placeholder="名稱" />

                    <input v-model.number="item.price"
                           type="number"
                           class="form-control mb-2"
                           placeholder="價格" />

                    <textarea v-model="item.description"
                              class="form-control mb-2"
                              rows="2"
                              placeholder="說明"></textarea>

                    <!-- 圖片 -->
                    <input type="file"
                           class="form-control mb-2"
                           accept="image/*"
                           @@change="e => onItemImageChange(e, item)" />

                    <img v-if="item.previewUrl"
                         :src="item.previewUrl"
                         class="img-fluid rounded mb-2"
                         style="max-height:120px;" />

                    <!-- 選項群組 -->
                    <div class="mt-3">

                        <div v-for="(group,gIndex) in item.optionGroups"
                             :key="gIndex"
                             class="border rounded p-2 mb-2">

                            <input v-model="group.groupName"
                                   class="form-control mb-2"
                                   placeholder="選項群組名稱（例如：飯量）" />

                            <div v-for="(opt,oIndex) in group.options"
                                 :key="oIndex"
                                 class="d-flex gap-2 mb-1">

                                <input v-model="opt.optionName"
                                       class="form-control"
                                       placeholder="選項名稱" />

                                <input v-model.number="opt.priceAdjust"
                                       type="number"
                                       class="form-control"
                                       placeholder="加價" />
                            </div>

                            <button class="btn btn-sm btn-outline-secondary"
                                    @@click="addOption(group)">
                                + 新增選項
                            </button>
                        </div>

                        <button class="btn btn-sm btn-outline-dark"
                                @@click="addOptionGroup(item)">
                            + 新增選項群組
                        </button>

                    </div>

                </div>

                <div class="d-flex justify-content-between">
                    <button class="btn btn-outline-dark"
                            @@click="addRow">
                        ＋ 再新增
                    </button>

                    <button class="btn btn-success"
                            @@click="submit">
                        儲存全部
                    </button>
                </div>

            </div>

        </div>

    </div>

</div>
<style>
    body {
        background: radial-gradient(circle at top, #fdf7ec 0, #f5f7fb 40%, #edf0ff 100%);
    }

    .menu-card {
        border-radius: 16px;
        border: 0;
        box-shadow: 0 18px 40px rgba(15, 23, 42, 0.06);
    }

    .menu-item-editor {
        border-radius: 12px;
        border: 0;
        box-shadow: 0 10px 25px rgba(15, 23, 42, 0.05);
    }

    .menu-preview {
        max-height: 420px;
        overflow-y: auto;
    }

    .menu-preview-list .list-group-item {
        border: 0;
        border-bottom: 1px solid rgba(0,0,0,0.04);
    }

        .menu-preview-list .list-group-item:last-child {
            border-bottom: 0;
        }

    .xsmall {
        font-size: 0.78rem;
    }

    .category-chip {
        display: inline-flex;
        align-items: center;
        padding: 4px 10px;
        border-radius: 999px;
        background-color: #f3f4f6;
        font-size: 0.78rem;
        color: #374151;
    }

    .category-dot {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background-color: #4b5563;
        margin-right: 6px;
    }

    .category-name {
        font-weight: 600;
    }

    .category-count {
        margin-left: 6px;
        color: #9ca3af;
    }

    .btn-dark-subtle {
        background-color: #1118270d;
        border-color: #1118271a;
    }
</style>

<script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<script>
    const { createApp } = Vue;

    createApp({

        data() {
            return {
                storeId: @storeId,
                categories: [],
                newCategoryName: '',
                existingMenu: [],
                coverFile: null,
                coverPreview: null,
                items: [
                    {
                        name: '',
                        price: 0,
                        description: '',
                        categoryId: null,
                        imageFile: null,
                        previewUrl: null,
                        optionGroups: []
                    }
                ]
            };
        },

        mounted() {
            this.loadCategories();
            this.loadExistingMenu();
        },

        methods: {

            loadCategories() {
                axios.get(`/api/storemenu/categories/${this.storeId}`)
                    .then(res => this.categories = res.data || []);
            },

            loadExistingMenu() {
                axios.get(`/api/storemenu/list/${this.storeId}`)
                    .then(res => this.existingMenu = res.data || []);
            },

            createCategory() {
                if (!this.newCategoryName) return;

                axios.post('/api/storemenu/category', {
                    storeId: this.storeId,
                    name: this.newCategoryName
                }).then(() => {
                    this.newCategoryName = '';
                    this.loadCategories();
                });
            },

            addRow() {
                this.items.push({
                    name: '',
                    price: 0,
                    description: '',
                    categoryId: null,
                    imageFile: null,
                    previewUrl: null,
                    optionGroups: []
                });
            },

            remove(index) {
                this.items.splice(index, 1);
            },

            onCoverChange(e) {
                const file = e.target.files[0];
                if (!file) return;
                this.coverFile = file;
                this.coverPreview = URL.createObjectURL(file);
            },

            onItemImageChange(e, item) {
                const file = e.target.files[0];
                if (!file) return;
                item.imageFile = file;
                item.previewUrl = URL.createObjectURL(file);
            },

            addOptionGroup(item) {
                item.optionGroups.push({
                    groupName: '',
                    options: []
                });
            },

            addOption(group) {
                group.options.push({
                    optionName: '',
                    priceAdjust: 0
                });
            },

            submit() {

                const validItems = this.items.filter(x => x.name && x.categoryId);

                if (validItems.length === 0) {
                    alert("請至少新增一個品項");
                    return;
                }

                const formData = new FormData();
                formData.append("storeId", this.storeId);

                if (this.coverFile) {
                    formData.append("coverImage", this.coverFile);
                }

                const itemsData = validItems.map((x, i) => {

                    if (x.imageFile) {
                        formData.append("itemImage_" + i, x.imageFile);
                    }

                    return {
                        name: x.name,
                        price: x.price,
                        description: x.description,
                        categoryId: x.categoryId,
                        optionGroups: x.optionGroups
                    };
                });

                formData.append("items", JSON.stringify(itemsData));

                axios.post('/api/storemenu/batchcreate', formData)
                    .then(() => {
                        alert("菜單已儲存");
                        this.loadExistingMenu();
                    })
                    .catch(() => {
                        alert("儲存失敗");
                    });
            }

        }

    }).mount('#app');
</script>