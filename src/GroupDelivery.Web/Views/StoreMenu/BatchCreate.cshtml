@{
    var storeId = ViewBag.StoreId;
}

<div id="app" class="container py-5">

    <div class="text-center mb-5">
        <h2 class="fw-bold">建立你的菜單</h2>
        <p class="text-muted">讓顧客一眼就想點餐</p>
    </div>

    <!-- 菜單封面圖片 -->
    <div class="card shadow-sm p-4 mb-5">
        <h5 class="fw-bold mb-3">菜單封面</h5>

        <input type="file"
               class="form-control"
               accept="image/*"
               @@change="onFileChange" />

        <div v-if="previewUrl" class="mt-4 text-center">
            <img :src="previewUrl"
                 class="img-fluid rounded shadow"
                 style="max-height:300px;" />
        </div>
    </div>

    <!-- 菜單品項 -->
    <div class="row g-4">

        <div class="col-md-4"
             v-for="(item,index) in items"
             :key="index">

            <div class="card h-100 shadow-sm menu-card">

                <div class="card-body">

                    <div class="d-flex justify-content-between mb-3">
                        <span class="badge bg-dark">
                            品項 {{ index + 1 }}
                        </span>

                        <button class="btn btn-sm btn-outline-danger"
                                @@click="remove(index)">
                            ✕
                        </button>
                    </div>

                    <div class="mb-3">
                        <label class="form-label small text-muted">
                            名稱
                        </label>
                        <input v-model="item.name"
                               class="form-control form-control-lg"
                               placeholder="例如：雞肉飯" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label small text-muted">
                            價格
                        </label>
                        <input v-model.number="item.price"
                               type="number"
                               class="form-control"
                               placeholder="70" />
                    </div>

                    <div>
                        <label class="form-label small text-muted">
                            說明
                        </label>
                        <textarea v-model="item.description"
                                  class="form-control"
                                  rows="2"
                                  placeholder="可不填"></textarea>
                    </div>

                    <div class="form-check mt-3">
                        <input class="form-check-input"
                               type="checkbox"
                               v-model="item.useTimeRange"
                               :id="`timeRange-${index}`" />
                        <label class="form-check-label" :for="`timeRange-${index}`">
                            指定供應時段
                        </label>
                    </div>

                    <div class="row g-2 mt-1" v-if="item.useTimeRange">
                        <div class="col-6">
                            <label class="form-label small text-muted">開始</label>
                            <input v-model="item.availableStartTime"
                                   type="time"
                                   class="form-control" />
                        </div>
                        <div class="col-6">
                            <label class="form-label small text-muted">結束</label>
                            <input v-model="item.availableEndTime"
                                   type="time"
                                   class="form-control" />
                        </div>
                    </div>

                </div>

            </div>
        </div>

    </div>

    <!-- 新增品項 -->
    <div class="text-center mt-5">
        <button class="btn btn-outline-dark btn-lg px-5"
                @@click="addRow">
            ＋ 新增品項
        </button>
    </div>

    <!-- 儲存 -->
    <div class="text-center mt-4">
        <button class="btn btn-success btn-lg px-5"
                @@click="submit">
            儲存全部菜單
        </button>
    </div>

</div>

<style>
    .menu-card {
        transition: all .2s ease;
        border-radius: 14px;
    }

        .menu-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 25px rgba(0,0,0,.08);
        }
</style>

<script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<script>
    const { createApp } = Vue;

    createApp({

        data() {
            return {
                storeId: @storeId,
                items: [
                    { name: '', price: 0, description: '', useTimeRange:false, availableStartTime:'', availableEndTime:'' }
                ],
                menuImage: null,
                previewUrl: null
            };
        },

        methods: {

            addRow() {
                this.items.push({ name: '', price: 0, description: '', useTimeRange:false, availableStartTime:'', availableEndTime:'' });
            },

            remove(index) {
                this.items.splice(index, 1);
            },

            onFileChange(e) {
                const file = e.target.files[0];
                if (!file) return;

                this.menuImage = file;
                this.previewUrl = URL.createObjectURL(file);
            },

            submit() {

                const formData = new FormData();

                formData.append("storeId", this.storeId);
                const normalizedItems = this.items.map(x => ({
                    name: x.name,
                    price: x.price,
                    description: x.description,
                    availableStartTime: x.useTimeRange ? x.availableStartTime : null,
                    availableEndTime: x.useTimeRange ? x.availableEndTime : null
                }));

                formData.append("items", JSON.stringify(normalizedItems));

                if (this.menuImage) {
                    formData.append("menuImage", this.menuImage);
                }

                axios.post('/api/store-menu/batchcreate', formData)
                .then(() => {
                    window.location.href =
                        `/Manage/${this.storeId}`;
                })
                .catch(err => {
                    console.error(err);
                    alert("儲存失敗");
                });
            }
        }

    }).mount('#app');
</script>
