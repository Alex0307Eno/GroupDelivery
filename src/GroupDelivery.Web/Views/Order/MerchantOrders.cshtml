@model List<IGrouping<int, GroupDelivery.Domain.Order>>
@using GroupDelivery.Domain

@{
    ViewData["Title"] = "商家訂單管理";
}

<style>
    .page-wrap {
        max-width: 1200px;
        margin: 0 auto;
    }

    .group-card {
        background: #ffffff;
        border-radius: 18px;
        padding: 1.8rem;
        box-shadow: 0 12px 30px rgba(0,0,0,.05);
        margin-bottom: 2.5rem;
        transition: .2s ease;
    }

        .group-card:hover {
            box-shadow: 0 18px 40px rgba(0,0,0,.08);
        }

    .group-title {
        font-size: 1.4rem;
        font-weight: 800;
    }

    .group-meta {
        font-size: .85rem;
        color: #6b7280;
    }

    .order-row {
        border-top: 1px solid #f1f5f9;
        padding-top: 1.2rem;
        margin-top: 1.2rem;
    }

    .user-name {
        font-weight: 700;
        font-size: 1rem;
    }

    .phone-link {
        font-size: .9rem;
        color: #2563eb;
        text-decoration: none;
    }

        .phone-link:hover {
            text-decoration: underline;
        }

    .total-box {
        font-weight: 800;
        font-size: 1.3rem;
        color: #111827;
    }

    .summary-bar {
        background: #f9fafb;
        border-radius: 12px;
        padding: 1rem 1.2rem;
        margin-top: 1.5rem;
    }

    .time-badge {
        font-size: .75rem;
        background: #e2e8f0;
        padding: .2rem .6rem;
        border-radius: 999px;
        margin-left: .5rem;
    }

    .item-row {
        font-size: .9rem;
        color: #475569;
    }
</style>

<div class="page-wrap py-4">

    <h2 class="fw-bold mb-4">商家訂單管理</h2>

    @if (!Model.Any())
    {
        <div class="text-muted">
            目前沒有任何訂單。
        </div>
    }
    else
    {
        foreach (var group in Model)
        {
            var first = group.First();
            var groupTotal = group.Sum(x => x.TotalAmount);
            var totalQty = group.Sum(x => x.OrderItems.Sum(i => i.Quantity));

            <div class="group-card">

                <!-- 團資訊 -->
                <div class="d-flex justify-content-between align-items-center">

                    <div>
                        <div class="group-title">
                            @first.GroupOrder.Store.StoreName
                        </div>
                        <div class="group-meta">
                            截止時間：
                            @first.GroupOrder.Deadline.ToString("yyyy/MM/dd HH:mm")
                        </div>
                    </div>

                    <div class="text-end">
                        <div class="total-box">
                            $@groupTotal
                        </div>
                        <div class="small text-muted">
                            共 @totalQty 份
                        </div>
                    </div>

                </div>

                <!-- 訂單列表（最新在上） -->
                @foreach (var order in group.OrderByDescending(o => o.CreatedAt))
                {
                    <div class="order-row">

                        <div class="d-flex justify-content-between align-items-start mb-2">

                            <div>
                                <div class="user-name">
                                    @order.User?.DisplayName
                                </div>

                                @if (!string.IsNullOrEmpty(order.User?.Phone))
                                {
                                    <div>
                                        <a class="phone-link"
                                           href="tel:@order.User.Phone">
                                            📞 @order.User.Phone
                                        </a>
                                    </div>
                                }
                            </div>

                            <div class="text-end">
                                <div class="fw-bold">
                                    $@order.TotalAmount
                                </div>
                                <div class="time-badge">
                                    @order.CreatedAt.ToString("MM/dd HH:mm")
                                </div>
                            </div>

                        </div>

                        @foreach (var item in order.OrderItems)
                        {
                            <div class="d-flex justify-content-between item-row">
                                <div>
                                    @item.StoreMenuItem.Name
                                </div>
                                <div>
                                    x @item.Quantity
                                </div>
                            </div>
                        }

                    </div>
                }

                <!-- 團總結 -->
                <div class="summary-bar d-flex justify-content-between align-items-center">
                    <div>
                        本團總金額：<strong>$@groupTotal</strong>
                    </div>

                    <button class="btn btn-outline-success btn-sm">
                        標記已出餐
                    </button>
                </div>

            </div>
        }
    }

</div>