@{
    ViewData["Title"] = "升級為商家";
}

<div id="app" class="container py-5"></div>

@section Scripts {
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>

    <script>
                const { createApp } = Vue;

                createApp({
                    data() {
                        return {
                            form: {
                                storeName: "",
                                storePhone: "",
                                storeAddress: ""
                            },
                            submitting: false,
                            error: null
                        };
                    },
                    methods: {
                        validate() {
                            if (!this.form.storeName) {
                                alert("請輸入店家名稱");
                                return false;
                            }
                            if (!this.form.storePhone) {
                                alert("請輸入店家電話");
                                return false;
                            }
                            if (!this.form.storeAddress) {
                                alert("請輸入店家地址");
                                return false;
                            }
                            return true;
                        },
                        async submit() {
                            if (!this.validate()) {
                                return;
                            }

                            this.submitting = true;
                            this.error = null;

                            try {
                                const res = await axios.post("/Account/UpgradeToMerchant", {
                                    storeName: this.form.storeName,
                                    storePhone: this.form.storePhone,
                                    storeAddress: this.form.storeAddress
                                });

                                // 如果後端回 Ok({ success: true })
                                if (res.data && res.data.success) {
                                    alert("已成功升級為商家");
                                    window.location.href = "/Account/Profile";
                                    return;
                                }

                                // 若你還在用 Redirect 版本，這邊其實也會被導走
                                // 這段只是保險
                                window.location.href = "/Account/Profile";

                            } catch (e) {
                                console.error(e);
                                this.error = "升級失敗，請稍後再試";
                            } finally {
                                this.submitting = false;
                            }
                        },
                        backToProfile() {
                            window.location.href = "/Account/Profile";
                        }
                    },
                    template: `
        <div class="row justify-content-center">
            <div class="col-md-6 col-lg-5">

                <div class="card shadow-sm border-0">
                    <div class="card-body p-4">

                        <h4 class="fw-bold mb-2 text-center">
                            升級為商家
                        </h4>

                        <p class="text-muted text-center mb-4 small">
                            升級後即可開團、管理店家資訊，讓附近的客人可以揪團向你下單。
                        </p>

                        <div v-if="error" class="alert alert-danger small">
                            {{ error }}
                        </div>

                        <div class="mb-3">
                            <label class="form-label">店家名稱</label>
                            <input type="text"
                                   class="form-control"
                                   v-model="form.storeName"
                                   placeholder="例如：阿樺便當、Alex 炸雞店" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">店家電話</label>
                            <input type="text"
                                   class="form-control"
                                   v-model="form.storePhone"
                                   placeholder="0912xxxxxx 或市話" />
                        </div>

                        <div class="mb-4">
                            <label class="form-label">店家地址</label>
                            <textarea class="form-control"
                                      rows="2"
                                      v-model="form.storeAddress"
                                      placeholder="請輸入完整地址"></textarea>
                        </div>

                        <button class="btn btn-warning w-100 fw-bold mb-2"
                                :disabled="submitting"
                                v-on:click="submit">
                            {{ submitting ? "送出中…" : "確認升級為商家" }}
                        </button>

                        <button type="button"
                                class="btn btn-outline-secondary w-100"
                                :disabled="submitting"
                                v-on:click="backToProfile">
                            先回個人資料頁
                        </button>

                    </div>
                </div>

            </div>
        </div>
                    `
                }).mount("#app");
    </script>
}
