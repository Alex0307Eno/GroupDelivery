@{
    ViewData["Title"] = "個人資料";
}

@if (TempData["Success"] != null)
{
    <div class="alert alert-success">
        @TempData["Success"]
    </div>
}

<style>
    body {
        background: radial-gradient(circle at top, #fef5e6 0, #f5f7fb 40%, #edf0ff 100%);
    }

    .profile-card {
        border-radius: 18px;
        box-shadow: 0 18px 45px rgba(15, 23, 42, 0.08);
        border: 0;
    }

    .profile-mini-card {
        border-radius: 14px;
        box-shadow: 0 12px 30px rgba(15, 23, 42, 0.06);
        border: 0;
    }

    .btn-soft {
        transition: transform .15s ease, box-shadow .15s ease;
    }

        .btn-soft:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 20px rgba(0,0,0,.12);
        }

    .fade-enter-active,
    .fade-leave-active {
        transition: opacity .25s ease, transform .25s ease;
    }

    .fade-enter-from,
    .fade-leave-to {
        opacity: 0;
        transform: translateY(8px);
    }
</style>

<div id="app" class="container py-5"></div>

@section Scripts {
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    user: null,
                    loading: true,
                    locating: false,
                    savingPhone: false,
                    savingMerchant: false
                };
            },
            computed: {
                isMerchant() {
                    return this.user && this.user.isMerchant === true;
                }
            },
            async mounted() {
                try {
                    const res = await axios.get('/Account/ProfileData');
                    this.user = res.data;
                } catch (e) {
                    alert('載入個人資料失敗');
                } finally {
                    this.loading = false;
                }
            },
            methods: {
                async savePhone() {
                    if (!this.user.phone) {
                        alert('請輸入手機號碼');
                        return;
                    }

                    this.savingPhone = true;
                    try {
                        await axios.post('/Account/UpdatePhone', {
                            phone: this.user.phone
                        });
                        alert('手機號碼已儲存');
                    } finally {
                        this.savingPhone = false;
                    }
                },

                async saveMerchantInfo() {
                    if (!this.user.storeName || !this.user.storePhone || !this.user.storeAddress) {
                        alert('請填寫完整商家資料');
                        return;
                    }

                    this.savingMerchant = true;
                    try {
                        await axios.post('/Account/UpdateMerchantInfo', {
                            storeName: this.user.storeName,
                            storePhone: this.user.storePhone,
                            storeAddress: this.user.storeAddress,
                            lat: this.user.lat,
                            lng: this.user.lng
                        });
                        alert('商家資料已儲存');
                    } finally {
                        this.savingMerchant = false;
                    }
                },

                locate() {
                    if (!navigator.geolocation) {
                        alert('瀏覽器不支援定位');
                        return;
                    }

                    this.locating = true;

                    navigator.geolocation.getCurrentPosition(async pos => {
                        const lat = pos.coords.latitude;
                        const lng = pos.coords.longitude;

                        this.user.lat = lat;
                        this.user.lng = lng;

                        const res = await axios.get('https://nominatim.openstreetmap.org/reverse', {
                            params: { lat, lon: lng, format: 'json' }
                        });

                        if (res.data?.display_name) {
                            this.user.storeAddress = res.data.display_name;
                        }

                        this.locating = false;
                    }, () => {
                        alert('定位失敗');
                        this.locating = false;
                    });
                }
            },
            template: `
            <transition name="fade">
                <div v-if="loading" class="text-center text-muted py-5">
                    載入中…
                </div>
            </transition>

            <transition name="fade">
                <div v-if="!loading && user" class="row justify-content-center">
                    <div class="col-md-7 col-lg-6">

                        <!-- 個人卡 -->
                        <div class="card profile-card mb-4">
                            <div class="card-body text-center">

                                <img v-if="user.pictureUrl"
                                     :src="user.pictureUrl"
                                     class="rounded-circle mb-3"
                                     style="width:96px;height:96px;object-fit:cover;">

                                <div v-else
                                     class="rounded-circle bg-light d-flex align-items-center justify-content-center mx-auto mb-3"
                                     style="width:96px;height:96px;font-size:32px;">
                                    {{ user.displayName?.charAt(0) || '?' }}
                                </div>

                                <h4 class="fw-bold">{{ user.displayName }}</h4>

                                <span class="badge"
                                      :class="isMerchant ? 'bg-warning text-dark' : 'bg-secondary'">
                                    {{ isMerchant ? '商家身分' : '一般使用者' }}
                                </span>

                                <hr>

                                <div class="text-start mb-3">
                                    <label class="form-label">手機號碼</label>
                                    <input class="form-control" v-model="user.phone">
                                </div>

                                <button class="btn btn-outline-primary w-100 mb-2 btn-soft"
                                        v-on:click="savePhone"
                                        :disabled="savingPhone">
                                    儲存手機號碼
                                </button>

                                <a v-if="!isMerchant"
                                   href="/Account/UpgradeToMerchant"
                                   class="btn btn-warning w-100 mb-2 btn-soft">
                                    升級為商家
                                </a>

                                <a href="/Auth/Logout"
                                   class="btn btn-outline-danger w-100 btn-soft">
                                    登出
                                </a>
                            </div>
                        </div>

                        <!-- 商家區 -->
                        <div v-if="isMerchant" class="card profile-mini-card">
                            <div class="card-body">

                                <h6 class="fw-bold mb-3">商家資料</h6>

                                <div class="mb-2">
                                    <input class="form-control" placeholder="店名" v-model="user.storeName">
                                </div>

                                <div class="mb-2">
                                    <input class="form-control" placeholder="店家電話" v-model="user.storePhone">
                                </div>

                                <div class="mb-3">
                                    <textarea class="form-control" rows="2"
                                              placeholder="店家地址"
                                              v-model="user.storeAddress"></textarea>
                                </div>

                                <button class="btn btn-outline-secondary w-100 mb-2 btn-soft"
                                        v-on:click="locate"
                                        :disabled="locating">
                                    使用目前位置填入地址
                                </button>

                                <button class="btn btn-warning w-100 btn-soft"
                                        v-on:click="saveMerchantInfo"
                                        :disabled="savingMerchant">
                                    儲存商家資料
                                </button>

                            </div>
                        </div>

                    </div>
                </div>
            </transition>
            `
        }).mount('#app');
    </script>
}
