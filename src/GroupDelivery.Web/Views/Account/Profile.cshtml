@{
    ViewData["Title"] = "我的帳號";
}

<style>
    body {
        background: #f6f8fc;
    }

    .page-wrap {
        max-width: 720px;
        margin: 0 auto;
        padding: 3rem 1rem;
    }

    .profile-card {
        background: #fff;
        border-radius: 20px;
        padding: 2.2rem;
        box-shadow: 0 18px 45px rgba(0,0,0,.06);
    }

    .section-title {
        font-size: .85rem;
        font-weight: 700;
        color: #6b7280;
        margin-bottom: .4rem;
    }

    .required {
        color: #ef4444;
    }

    .input-modern {
        border: 1px solid #e5e7eb;
        border-radius: 14px;
        padding: .75rem 1rem;
        font-size: .95rem;
        width: 100%;
        margin-bottom: 1.2rem;
        transition: .2s;
    }

        .input-modern:focus {
            outline: none;
            border-color: #111827;
        }

    .error-box {
        background: #fee2e2;
        color: #b91c1c;
        font-size: .85rem;
        padding: .6rem 1rem;
        border-radius: 12px;
        margin-bottom: 1rem;
    }

    .success-box {
        background: #dcfce7;
        color: #166534;
        font-size: .85rem;
        padding: .6rem 1rem;
        border-radius: 12px;
        margin-bottom: 1rem;
    }

    .btn-primary-clean {
        background: #111827;
        color: #fff;
        border: none;
        border-radius: 999px;
        padding: .85rem;
        font-weight: 700;
        width: 100%;
    }

        .btn-primary-clean:disabled {
            opacity: .6;
        }
</style>

<div id="app" class="container"></div>

@section Scripts {
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    user: null,
                    loading: true,
                    saving: false,
                    errorMessage: "",
                    successMessage: ""
                }
            },

            async mounted() {
                try {
                    const res = await axios.get('/Account/ProfileData');
                    this.user = res.data;
                } catch {
                    this.errorMessage = "載入失敗";
                }
                this.loading = false;
            },

            methods: {

                async saveProfile() {

                    this.errorMessage = "";
                    this.successMessage = "";

                    // 暱稱驗證
                    if (!this.user.nickname || this.user.nickname.trim().length < 2) {
                        this.errorMessage = "暱稱至少 2 個字";
                        return;
                    }

                    if (this.user.nickname.trim().length > 20) {
                        this.errorMessage = "暱稱不可超過 20 個字";
                        return;
                    }

                    this.user.nickname = this.user.nickname.trim();

                    // 手機驗證
                    if (!this.user.phone || this.user.phone.trim() === "") {
                        this.errorMessage = "請填寫手機號碼";
                        return;
                    }

                    const phoneRegex = /^09\d{8}$/;

                    if (!phoneRegex.test(this.user.phone)) {
                        this.errorMessage = "手機格式錯誤 (09xxxxxxxx)";
                        return;
                    }

                    // 地址驗證
                    if (!this.user.city || this.user.city.trim().length < 6) {
                        this.errorMessage = "請填寫完整地址";
                        return;
                    }

                    if (!this.user.city.includes("市") && !this.user.city.includes("縣")) {
                        this.errorMessage = "地址需包含縣市";
                        return;
                    }

                    this.saving = true;

                    try {
                        await axios.post('/Account/UpdateProfile', this.user);

                        this.successMessage = "儲存成功";

                        setTimeout(() => {
                            this.successMessage = "";
                        }, 2000);

                    } catch (e) {
                        this.errorMessage = e.response?.data || "儲存失敗";
                    }

                    this.saving = false;
                }
            },

            template: `
            <div v-if="loading" class="text-center py-5 text-muted">
                載入中...
            </div>

            <div v-else class="page-wrap">
                <div class="profile-card">

                    <div v-if="errorMessage" class="error-box">
                        {{ errorMessage }}
                    </div>

                    <div v-if="successMessage" class="success-box">
                        {{ successMessage }}
                    </div>

                    <div class="section-title">
                        暱稱 <span class="required">*</span>
                    </div>
                    <input class="input-modern"
                           placeholder="2~20 個字"
                           v-model="user.nickname">

                    <div class="section-title">
                        手機號碼 <span class="required">*</span>
                    </div>
                    <input class="input-modern"
                           v-model="user.phone">

                    <div class="section-title">
                        完整地址 <span class="required">*</span>
                    </div>
                    <input class="input-modern"
                           placeholder="例如：台中市西屯區文心路二段100號"
                           v-model="user.city">

                    <div class="section-title">自我介紹</div>
                    <textarea class="input-modern"
                              rows="3"
                              v-model="user.bio"></textarea>

                    <button class="btn-primary-clean"
                            :disabled="saving"
                            v-on:click="saveProfile">
                        {{ saving ? "儲存中..." : "儲存變更" }}
                    </button>

                </div>
            </div>
            `
        }).mount('#app');
    </script>
}