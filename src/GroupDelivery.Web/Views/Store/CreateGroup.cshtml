@{
    ViewData["Title"] = "揪IN｜商家開團";
}

<style>
    .fade-up {
        animation: fadeUp .6s ease both;
    }

    .fade-delay-1 {
        animation-delay: .1s;
    }

    .fade-delay-2 {
        animation-delay: .2s;
    }

    .fade-delay-3 {
        animation-delay: .3s;
    }

    @@keyframes fadeUp {
        from {
            opacity: 0;
            transform: translateY(16px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .compare-box {
        background: #f8fafc;
        border-radius: 1rem;
        padding: 1.2rem;
        font-size: .9rem;
        margin-top: 1.5rem;
    }

        .compare-box strong {
            color: #111827;
        }

    .hint-strong {
        font-size: .9rem;
        font-weight: 700;
        margin-top: .4rem;
    }
</style>

<div id="app" class="container py-5">

    <div class="create-wrap">

        <!-- HERO -->
        <div class="hero-box fade-up">
            <div class="hero-title">
                開一團，<br />
                只送「值得送」的訂單
            </div>
            <div class="hero-sub">
                人沒湊齊就不出單，成本你說了算
            </div>
        </div>

        <!-- FORM -->
        <div class="card-box fade-up fade-delay-1">

            <!-- 店家 -->
                <div class="mb-4">
                    <label class="form-label">店家</label>

                <!-- 沒有可開團的店 -->
                <div v-if="availableStores.length === 0"
                     class="alert alert-warning">
                    目前沒有營業中的商店，請先取消休息設定
                </div>

                <!-- 只有一家可開團 -->
                <input v-else-if="availableStores.length === 1"
                       class="form-control shadow-sm"
                       :value="availableStores[0].storeName"
                       disabled>

                <!-- 多家可開團 -->
                <select v-else
                        class="form-select shadow-sm"
                        v-model="selectedStoreId"
                        @@change ="form.storeId = selectedStoreId">
                    <option disabled value="">請選擇店家</option>
                    <option v-for="s in availableStores"
                            :key="s.storeId"
                            :value="s.storeId">
                        {{ s.storeName }}
                    </option>
                </select>


                    
                </div>

                

            <div class="divider"></div>

            <!-- 成團金額 -->
            <div class="mb-4">
                <label class="form-label">成團金額</label>
                <div class="form-hint">
                    沒達標就不會出單
                </div>

                <div class="input-group shadow-sm">
                    <span class="input-group-text">$</span>
                    <input type="number"
                           class="form-control"
                           v-model.number="form.targetAmount"
                           placeholder="例如：800">
                </div>

                <div v-if="targetHint"
                     class="hint-strong text-primary">
                    {{ targetHint }}
                </div>
            </div>

            <!-- 截止時間 -->
            <div class="mb-4 fade-up fade-delay-2">
                <label class="form-label">截止時間</label>

                <!-- 快捷按鈕 -->
                <div class="btn-group w-100 mb-2">
                    <button class="btn"
                            :class="selectedPreset === 30 ? 'btn-primary' : 'btn-outline-primary'"
                            @@click ="setDeadline(30)">
                        30 分鐘
                    </button>

                    <button class="btn"
                            :class="selectedPreset === 45 ? 'btn-primary' : 'btn-outline-primary'"
                            @@click ="setDeadline(45)">
                        45 分鐘
                    </button>

                    <button class="btn"
                            :class="selectedPreset === 60 ? 'btn-primary' : 'btn-outline-primary'"
                            @@click ="setDeadline(60)">
                        60 分鐘
                    </button>
                </div>


                <!-- 自訂 -->
                <div class="mt-2">
                    <button class="btn btn-link p-0"
                            @@click ="showCustom = !showCustom">
                        {{ showCustom ? '收起自訂時間' : '需要自訂時間？' }}
                    </button>
                </div>

                <div v-if="showCustom" class="mt-2">
                    <div class="input-group">
                        <input type="number"
                               class="form-control"
                               min="10"
                               max="240"
                               placeholder="輸入分鐘數（例如 75）"
                               v-model.number="customMinutes">
                        <span class="input-group-text">分鐘後</span>
                    </div>

                    <button class="btn btn-outline-secondary w-100 mt-2"
                            @@click ="applyCustomDeadline">
                        套用自訂時間
                    </button>
                </div>

                <!-- 顯示結果 -->
                <div class="small text-muted mt-2">
                    截止時間：<strong>{{ formattedDeadline }}</strong>
                </div>

            </div>

            <!-- 外送距離 -->
            <div class="mb-4 fade-up fade-delay-3">
                <label class="form-label">外送距離上限（公里）</label>
                <div class="form-hint">
                    只通知會來的人
                </div>
                <input type="number"
                       class="form-control shadow-sm"
                       v-model.number="form.deliveryRange">
            </div>

            <!-- 備註 -->
            <div class="mb-4">
                <label class="form-label">團購說明（選填）</label>
                <textarea class="form-control shadow-sm"
                          rows="3"
                          v-model="form.remark"></textarea>
            </div>

            <!-- 差異對比 -->
            <div class="compare-box">
                <strong>揪 IN 跟外送平台差在哪？</strong>
                <ul class="mt-2 mb-0 ps-3">
                    <li>外送平台：一單也得送</li>
                    <li><strong>揪 IN：人沒湊齊，不出單</strong></li>
                    <li class="mt-1">外送平台：抽成固定</li>
                    <li><strong>揪 IN：條件你先決定</strong></li>
                </ul>
            </div>

            <!-- CTA -->
            <button class="btn btn-primary w-100 submit-btn mt-4"
                    :disabled="submitting"
                    @@click="submitForm">
                {{ submitting ? '建立中…' : '建立湊單團' }}
            </button>

        </div>
    </div>
</div>

@section Scripts {
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    stores: [],
                    selectedStoreId: null,
                     selectedPreset: null,
                    showCustom: false,
                    customMinutes: null,
                    submitting: false,

                    form: {
                        storeId: null,
                        targetAmount: null,
                        deadline: "",
                        deliveryRange: 3,
                        remark: ""
                    }
                };
            },

        mounted() {
            axios.get('/api/merchant/stores')
                .then(res => {
                    this.stores = res.data || [];

                    const openStores = this.availableStores;

                    if (openStores.length === 1) {
                        this.selectedStoreId = openStores[0].storeId;
                        this.form.storeId = this.selectedStoreId;
                    }
                })
                .catch(() => {
                    alert("無法取得店家資料");
                });
        },

            computed: {
                    availableStores() {
            return this.stores.filter(s => s.isOpenNow);
        },
                formattedDeadline() {
                    if (!this.form.deadline) return '尚未設定';
                    return new Date(this.form.deadline).toLocaleString();
                },

                targetHint() {
                    if (!this.form.targetAmount) return "";
                    if (this.form.targetAmount < 500)
                        return "金額偏低，可能很快成團";
                    if (this.form.targetAmount < 1000)
                        return "常見設定，轉換率穩定";
                    return "金額偏高，建議搭配推播";
                }
            },

            methods: {
                setDeadline(minutes) {
                    const d = new Date();
                    d.setMinutes(d.getMinutes() + minutes);
                    this.form.deadline = d.getFullYear() + '-' +
                    String(d.getMonth() + 1).padStart(2, '0') + '-' +
                    String(d.getDate()).padStart(2, '0') + 'T' +
                    String(d.getHours()).padStart(2, '0') + ':' +
                    String(d.getMinutes()).padStart(2, '0');

                    this.selectedPreset = minutes;
                    this.showCustom = false;
                },

                applyCustomDeadline() {
                    if (!this.customMinutes || this.customMinutes < 10) {
                        alert('請輸入至少 10 分鐘');
                        return;
                    }

                    const d = new Date();
                    d.setMinutes(d.getMinutes() + this.customMinutes);
                    this.form.deadline = d.toISOString();
                    this.selectedPreset = null;
                },

                submitForm() {
                    if (!this.form.storeId) {
                        alert("請選擇店家");
                        return;
                    }

                    if (!this.form.targetAmount || !this.form.deadline) {
                        alert("請填寫成團金額與截止時間");
                        return;
                    }

                    this.submitting = true;

                    axios.post('/api/merchant/groups', this.form)
                        .then(() => {
                            location.href = "/Home/Index";
                        })
                        .catch(() => {
                            alert("建立失敗，請稍後再試");
                        })
                        .finally(() => {
                            this.submitting = false;
                        });
                }
            }
        }).mount('#app');
    </script>
}
