@{
    ViewData["Title"] = "揪IN｜商家開團";
}

<style>
    body {
        background: #f5f7fb;
    }

    .create-wrap {
        max-width: 680px;
        margin: auto;
    }

    .hero-title {
        font-size: 2.2rem;
        font-weight: 800;
    }

    .hero-sub {
        color: #6b7280;
    }

    .card-box {
        background: #fff;
        border-radius: 20px;
        padding: 2.5rem;
        box-shadow: 0 18px 40px rgba(0,0,0,.06);
    }

    .time-grid {
        display: grid;
        grid-template-columns: repeat(3,1fr);
        gap: 10px;
        margin-top: 15px;
    }

    .time-btn.active {
        background: #111827;
        color: #fff;
        transform: scale(1.05);
    }

    .countdown-box {
        background: #f1f5f9;
        padding: 10px;
        border-radius: 10px;
        margin-top: 10px;
        font-weight: 600;
    }

    .custom-box {
        margin-top: 15px;
        padding: 12px;
        background: #f9fafb;
        border-radius: 12px;
    }

    .submit-btn {
        height: 56px;
        font-weight: 700;
        border-radius: 999px;
    }
</style>

<div id="app" class="container py-5">
    <div class="create-wrap">

        <div class="hero-box mb-4">
            <div class="hero-title">
                開一團，只送值得送的訂單
            </div>
            <div class="hero-sub">
                達標才出單，你掌控成本
            </div>
        </div>

        <div class="card-box">

            <!-- 店家 -->
            <div class="mb-4" v-if="stores.length > 1">
                <label class="form-label">店家</label>
                <select class="form-select" v-model="form.storeId">
                    <option disabled value="">請選擇店家</option>
                    <option v-for="s in stores"
                            :key="s.storeId"
                            :value="s.storeId">
                        {{ s.storeName }}
                    </option>
                </select>
            </div>

            <div class="mb-4" v-else-if="stores.length === 1">
                <label class="form-label">店家</label>
                <div class="form-control bg-light">
                    {{ stores[0].storeName }}
                </div>
            </div>

            <div class="mb-4 text-danger" v-else>
                你目前尚未建立商店
            </div>

            <!-- 成團金額 -->
            <div class="mb-4">
                <label class="form-label">成團金額</label>

                <div class="input-group mt-2">
                    <span class="input-group-text">$</span>
                    <input type="number"
                           class="form-control"
                           v-model.number="form.targetAmount"
                           disabled>
                </div>

                <div v-if="thresholdNote"
                     class="small text-muted mt-2">
                    {{ thresholdNote }}
                </div>

                <div v-if="!form.storeId"
                     class="small text-muted mt-2">
                    請先選擇店家
                </div>
            </div>

            <!-- 截止時間 -->
            <div class="mb-4">
                <label class="form-label">截止時間</label>

                <!-- 快速選擇 -->
                <div class="time-grid">
                    <button v-for="t in timeOptions"
                            :key="t.value"
                            class="btn btn-outline-dark"
                            :class="form.deadline === t.value ? 'active' : ''"
                            @@click="selectTime(t.value)">
                        {{ t.label }}
                    </button>
                </div>

                <!-- 自訂時間 -->
                <div class="custom-box">
                    <div class="small text-muted mb-1">
                        或自訂時間
                    </div>
                    <input type="datetime-local"
                           class="form-control"
                           v-model="customDeadline"
                           @@change="applyCustom">
                </div>

                <!-- 倒數 -->
                <div v-if="countdown"
                     class="countdown-box">
                    ⏳ 剩餘 {{ countdown }}
                </div>

                <div class="small text-muted mt-2">
                    截止時間：<strong>{{ formattedDeadline }}</strong>
                </div>
            </div>

            <!-- 備註 -->
            <div class="mb-4">
                <label class="form-label">團購說明（選填）</label>
                <textarea class="form-control"
                          rows="3"
                          v-model="form.remark"></textarea>
            </div>

            <!-- CTA -->
            <button class="btn btn-dark w-100 submit-btn"
                    :disabled="submitting"
                    @@click="submitForm">
                {{ submitting ? '建立中…' : '建立湊單團' }}
            </button>

        </div>

    </div>
</div>

@section Scripts {
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <script>
                const { createApp } = Vue;

        createApp({

            data(){
                return{
                    stores:[],
                    submitting:false,
                    countdown:"",
                    customDeadline:"",
                    thresholdNote:"",
                    form:{
                        storeId:null,
                        targetAmount:null,
                        deadline:"",
                        remark:""
                    },
                    timeOptions:[]
                }
            },

            mounted(){

                    axios.get('/api/merchant/stores')
        .then(res=>{
            this.stores = res.data || [];

            if(this.stores.length === 1){
                this.form.storeId = this.stores[0].storeId;
            }
        });

                this.generateTimeOptions();
                setInterval(this.updateCountdown,1000);
            },

            watch:{
                'form.storeId'(newVal){

                    if(!newVal){
                        this.form.targetAmount = null;
                        this.thresholdNote = "";
                        return;
                    }

                    axios.get(`/api/merchant/stores/${newVal}/delivery-threshold`)
                        .then(res=>{

                            const amount = res.data.targetAmount || 0;

                            this.form.targetAmount = amount;

                            if(amount > 0){
                                this.thresholdNote =
                                    "成團金額依外送門檻自動設定為 $" +
                                    amount.toLocaleString();
                            }
                            else{
                                this.thresholdNote =
                                    "此店尚未設定外送門檻";
                            }
                        });
                }
            },

            computed:{
                formattedDeadline(){
                    if(!this.form.deadline) return "尚未設定";
                    return this.form.deadline.replace('T',' ');
                }
            },

            methods:{

                generateTimeOptions(){

                    const now = new Date();
                    const minTime = new Date(now.getTime() + 15*60000);

                    const options=[];

                    for(let i=0;i<6;i++){

                        const d=new Date(minTime);
                        d.setMinutes(0);
                        d.setHours(minTime.getHours() + Math.floor(i/2));
                        if(i%2===1) d.setMinutes(30);

                        if(d <= minTime) continue;

                        const label =
                            String(d.getHours()).padStart(2,'0') +
                            ':' +
                            String(d.getMinutes()).padStart(2,'0');

                        const value =
                            d.getFullYear() + '-' +
                            String(d.getMonth()+1).padStart(2,'0') + '-' +
                            String(d.getDate()).padStart(2,'0') + 'T' +
                            String(d.getHours()).padStart(2,'0') + ':' +
                            String(d.getMinutes()).padStart(2,'0');

                        options.push({ label,value });
                    }

                    this.timeOptions=options;
                },

                selectTime(value){
                    this.form.deadline=value;
                    this.customDeadline="";
                },

                applyCustom(){

                    if(!this.customDeadline) return;

                    const selected=new Date(this.customDeadline);
                    const now=new Date();

                    if(selected <= now){
                        alert("自訂時間不可小於現在");
                        this.customDeadline="";
                        return;
                    }

                    this.form.deadline=this.customDeadline;
                },

                updateCountdown(){

                    if(!this.form.deadline){
                        this.countdown="";
                        return;
                    }

                    const now=new Date();
                    const target=new Date(this.form.deadline);
                    const diff=target-now;

                    if(diff<=0){
                        this.countdown="已截止";
                        return;
                    }

                    const hours=Math.floor(diff/3600000);
                    const minutes=Math.floor((diff%3600000)/60000);
                    const seconds=Math.floor((diff%60000)/1000);

                    this.countdown=
                        String(hours).padStart(2,'0') + " 小時 " +
                        String(minutes).padStart(2,'0') + " 分 " +
                        String(seconds).padStart(2,'0') + " 秒";
                },

                submitForm(){

                    if(!this.form.storeId){
                        alert("請選擇店家");
                        return;
                    }

                    if(!this.form.targetAmount){
                        alert("此店尚未設定外送門檻");
                        return;
                    }

                    if(!this.form.deadline){
                        alert("請設定截止時間");
                        return;
                    }

                    this.submitting=true;

                    axios.post('/api/merchant/groups',this.form)
                        .then(()=>location.href="/Home/Index")
                        .catch(()=>alert("建立失敗"))
                        .finally(()=>this.submitting=false);
                }

            }

        }).mount('#app');
    </script>
}