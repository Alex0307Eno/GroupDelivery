@{
    ViewData["Title"] = "揪IN｜不湊不送，一湊就動";
}

<style>
    body {
        background: #f9fafb;
    }

    .hero-simple {
        padding: 4rem 1rem 3rem;
    }

        .hero-simple h1 {
            font-size: 2.4rem;
            font-weight: 800;
        }

        .hero-simple p {
            font-size: 1.1rem;
            color: #6b7280;
        }

    .search-bar-wrap {
        border-radius: 999px;
        box-shadow: 0 8px 24px rgba(15, 23, 42, .08);
        overflow: hidden;
        background: #fff;
    }

    .card-group {
        border-radius: 1rem;
        border: none;
        box-shadow: 0 10px 28px rgba(15, 23, 42, .12);
        transition: transform .15s ease, box-shadow .15s ease;
    }

        .card-group:hover {
            transform: translateY(-4px);
            box-shadow: 0 16px 40px rgba(15, 23, 42, .18);
        }

    .card-img-top.cover {
        height: 170px;
        background-position: center;
        background-size: cover;
    }

    .progress-sm {
        height: 0.45rem;
        border-radius: 999px;
        overflow: hidden;
        background: #e5e7eb;
    }

        .progress-sm .progress-bar {
            border-radius: 999px;
        }
</style>

<div id="app" class="container py-4">

    <!-- HERO -->
    <div class="hero-simple text-center">
        <h1>不湊不送，一湊就動</h1>
        <p class="mt-3 mb-4">
            人湊齊才送，順路一起吃。<br />
            不抽成壓商家，不讓外送費壓垮你。
        </p>

        <div class="d-flex justify-content-center gap-3">
            <a href="#groups" class="btn btn-dark btn-lg">
                我要跟團
            </a>
            @if (User.Identity.IsAuthenticated)
            {
                <a href="/Store/CreateGroup" class="btn btn-outline-dark btn-lg">
                    我是商家，開團
                </a>
            }
            else
            {
                <a href="#"
                   class="btn btn-outline-dark btn-lg"
                   data-bs-toggle="modal"
                   data-bs-target="#authModal">
                    我是商家，開團
                </a>
            }

        </div>
    </div>

    <!-- 搜尋 -->
    <div class="row mb-4">
        <div class="col-md-8 mx-auto">
            <div class="search-bar-wrap input-group">
                <input type="text"
                       class="form-control"
                       placeholder="搜尋店名或團名…"
                       v-model="searchQuery" />
                <button class="btn btn-dark">
                    搜尋
                </button>
            </div>
        </div>
    </div>

    <!-- 團購列表 -->
    <div v-if="loading" class="text-center py-5">
        <div class="spinner-border text-dark"></div>
        <p class="text-muted mt-3">正在載入揪團…</p>
    </div>

    <div v-else id="groups" class="row g-4">
        <div v-for="group in filteredGroups"
             :key="group.groupOrderId"
             class="col-lg-4 col-md-6">

            <div class="card card-group">

                <div class="card-img-top cover"
                     :style="{
                        backgroundImage: `url(${group.store && group.store.coverImageUrl
                            ? group.store.coverImageUrl
                            : '/img/store-placeholder.jpg'})`
                     }">
                </div>

                <div class="card-body d-flex flex-column">

                    <h5 class="fw-bold mb-2">
                        {{ group.remark || group.store.storeName }}
                    </h5>

                    <p class="small text-muted mb-2">
                        還差 ${{ leftAmount(group) }} 出發
                    </p>

                    <div class="progress progress-sm mb-3">
                        <div class="progress-bar bg-success"
                             :style="{ width: calculatePercent(group) + '%' }">
                        </div>
                    </div>

                    <a :href="'/Group/GroupDetail/' + group.groupOrderId"
                       class="btn btn-dark w-100 mt-auto">
                        立刻加入
                    </a>

                </div>
            </div>
        </div>

        <div v-if="filteredGroups.length === 0"
             class="col-12 text-center text-muted py-5">
            目前沒有揪團。<br />
            不如自己開一團？
        </div>
    </div>

</div>

<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<script>
    const { createApp } = Vue;

    createApp({
        data() {
            return {
                groups: [],
                loading: true,
                searchQuery: ''
            };
        },
        computed: {
            filteredGroups() {
                if (!this.searchQuery) {
                    return this.groups;
                }

                const k = this.searchQuery.toLowerCase();

                return this.groups.filter(g => {
                    const name = g.store && g.store.storeName
                        ? g.store.storeName.toLowerCase()
                        : '';
                    const remark = g.remark ? g.remark.toLowerCase() : '';
                    return name.includes(k) || remark.includes(k);
                });
            }
        },
        methods: {
            fetchGroups() {
                axios.get('/api/groups')
                    .then(res => {
                        this.groups = res.data || [];
                        this.loading = false;
                    })
                    .catch(() => {
                        this.loading = false;
                    });
            },
            calculatePercent(g) {
                const current = g.currentAmount || 0;
                const target = g.targetAmount || 0;
                if (target <= 0) return 0;
                let v = Math.round(current * 100 / target);
                if (v > 100) v = 100;
                if (v < 0) v = 0;
                return v;
            },
            leftAmount(g) {
                const current = g.currentAmount || 0;
                const target = g.targetAmount || 0;
                let left = target - current;
                if (left < 0) left = 0;
                return left;
            }
        },
        mounted() {
            this.fetchGroups();
        }
    }).mount('#app');
</script>
