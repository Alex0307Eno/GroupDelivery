@{
    ViewData["Title"] = "æªINï½œä¸æ¹Šä¸é€ï¼Œä¸€æ¹Šå°±å‹•";
}
<style>
    body {
        background: linear-gradient(180deg,#f9fafb,#eef2f7);
    }

    .hero-simple {
        padding: 4rem 1rem 3rem;
    }

        .hero-simple h1 {
            font-size: 2.6rem;
            font-weight: 800;
            letter-spacing: -1px;
        }

    .radius-btn {
        min-width: 120px;
        transition: .2s ease;
    }

        .radius-btn.active {
            background: #111827;
            color: #fff;
            transform: translateY(-2px);
        }

    .card-group {
        border-radius: 1rem;
        border: none;
        box-shadow: 0 12px 28px rgba(15,23,42,.08);
        transition: .2s ease;
        overflow: hidden;
    }

        .card-group:hover {
            transform: translateY(-6px);
            box-shadow: 0 20px 40px rgba(15,23,42,.15);
        }

    .cover {
        height: 180px;
        background-size: cover;
        background-position: center;
        position: relative;
    }

    .badge-row {
        position: absolute;
        top: 12px;
        right: 12px;
        display: flex;
        gap: 8px;
    }

    .hot-badge {
        background: linear-gradient(135deg,#ef4444,#dc2626);
        color: #fff;
        padding: 4px 10px;
        border-radius: 999px;
        font-size: .75rem;
    }

    .distance-badge {
        background: rgba(0,0,0,.7);
        color: #fff;
        padding: 4px 10px;
        border-radius: 999px;
        font-size: .75rem;
    }

    .progress-sm {
        height: 6px;
        border-radius: 999px;
    }
</style>

<div id="app" class="container py-4">

    <div class="hero-simple text-center">
        <h1>ä¸æ¹Šä¸é€ï¼Œä¸€æ¹Šå°±å‹•</h1>
        <p class="mt-3 mb-4 text-muted">
            é™„è¿‘æœ‰äººé–‹åœ˜æ‰é€ï¼Œé †è·¯ä¸€èµ·åƒã€‚
        </p>

        <div class="d-flex justify-content-center gap-3">

            <button class="btn radius-btn btn-outline-dark btn-lg"
                    :class="{ active: radius === 3 }"
                    @@click="setRadius(3)">
                3km å…§
            </button>

            <button class="btn radius-btn btn-outline-dark btn-lg"
                    :class="{ active: radius === 5 }"
                    @@click="setRadius(5)">
                5km å…§
            </button>

        </div>

        <div v-if="radius === 3 && hasFiveKmButNotThree"
             class="mt-3 text-muted small">
            3km å…§æ²’æœ‰åœ˜ï¼Œ5km å…§æœ‰ {{ fiveKmCount }} åœ˜
        </div>

    </div>

    <div v-if="loading" class="text-center py-5">
        <div class="spinner-border text-dark"></div>
        <p class="mt-3 text-muted">æ­£åœ¨æœå°‹é™„è¿‘æªåœ˜...</p>
    </div>

    <div v-else class="row g-4">

        <div v-for="group in filteredGroups"
             :key="group.groupOrderId"
             class="col-lg-4 col-md-6">

            <div class="card card-group">

                <div class="cover"
                     :style="{ backgroundImage: 'url(' + getImageUrl(group.store?.coverImageUrl) + ')' }">

                    <div class="badge-row">

                        <div v-if="isHot(group)" class="hot-badge">
                            ğŸ”¥ å¿«æˆåœ˜
                        </div>

                        <div class="distance-badge"
                             v-if="group.distance != null">
                            {{ group.distance.toFixed(1) }} km
                        </div>

                    </div>

                </div>

                <div class="card-body d-flex flex-column">

                    <h5 class="fw-bold mb-1">
                        {{ group.remark || group.store?.storeName }}
                    </h5>

                    <small class="text-muted mb-2">
                        é‚„å·® ${{ leftAmount(group) }} å‡ºç™¼
                    </small>

                    <div class="progress progress-sm mb-3">
                        <div class="progress-bar bg-success"
                             :style="{ width: percent(group) + '%' }">
                        </div>
                    </div>

                    <small class="text-muted mb-3">
                        â° {{ remainingTime(group.deadline) }}
                    </small>

                    <button class="btn btn-dark w-100"
                            @@click="handleJoin(group)">
                        ç«‹åˆ»åŠ å…¥
                    </button>

                </div>

            </div>

        </div>

        <div v-if="filteredGroups.length === 0"
             class="text-center text-muted py-5">
            é™„è¿‘ç›®å‰æ²’æœ‰é–‹åœ˜ ğŸ˜¢
        </div>

    </div>
</div>

<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<script>
    const { createApp } = Vue;

    createApp({

    data() {
        return {
            groups: [],
            loading: true,
            radius: 3,
            isAuthenticated: @User.Identity.IsAuthenticated.ToString().ToLower()
        };
    },

    computed: {

        filteredGroups() {
            return this.groups
                .filter(g => g.distance != null && g.distance <= this.radius)
                .sort((a,b) => a.distance - b.distance);
        },

        fiveKmCount() {
            return this.groups.filter(g => g.distance != null && g.distance <= 5).length;
        },

        hasFiveKmButNotThree() {
            return this.fiveKmCount > 0 &&
                   this.groups.filter(g => g.distance != null && g.distance <= 3).length === 0;
        }

    },

    methods: {

        setRadius(km) {
            this.radius = km;
        },

        fetchGroups() {
            axios.get("/api/groups")
                .then(res => {
                    this.groups = res.data || [];
                    this.loading = false;
                });
        },

        getImageUrl(path) {
            if (!path) return '/img/store-placeholder.jpg';
            if (path.startsWith('http')) return path;
            return window.location.origin + path;
        },

        percent(g) {
            if (!g.targetAmount) return 0;
            let v = Math.round(g.currentAmount * 100 / g.targetAmount);
            return v > 100 ? 100 : v;
        },

        leftAmount(g) {
            return Math.max(g.targetAmount - g.currentAmount, 0);
        },

        isHot(g) {
            return this.percent(g) >= 80;
        },

        remainingTime(deadline) {
            const diff = new Date(deadline) - new Date();
            if (diff <= 0) return "å·²æˆªæ­¢";
            const mins = Math.floor(diff / 60000);
            if (mins < 60) return mins + " åˆ†é˜å¾Œæˆªæ­¢";
            const hrs = Math.floor(mins / 60);
            return hrs + " å°æ™‚å¾Œæˆªæ­¢";
        },

        handleJoin(group) {

            if (!this.isAuthenticated) {
                var authModalEl = document.getElementById('authModal');
                if (authModalEl && window.bootstrap) {
                    new bootstrap.Modal(authModalEl).show();
                } else {
                    window.location.href = '/Account/Login';
                }
                return;
            }

            window.location.href = '/Group/GroupDetail/' + group.groupOrderId;
        }

    },

    mounted() {
        this.fetchGroups();
    }

    }).mount("#app");
</script>