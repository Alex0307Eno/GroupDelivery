@{
    ViewData["Title"] = "參加湊單";
}

<div id="app">
    <div v-if="loading" class="text-center py-5">
        <div class="spinner-border text-primary" role="status"></div>
    </div>

    <div v-else-if="group" class="row">
        <!-- 左側：店家資訊與商品列表 -->
        <div class="col-lg-8">
            <div class="premium-card p-4 mb-4">
                <div class="d-flex align-items-center mb-3">
                    <h2 class="fw-bold mb-0">{{ group.Store.StoreName }}</h2>
                    <span class="ms-3 store-badge">{{ group.Store.Phone }}</span>
                </div>
                <p class="text-muted"><i class="bi bi-geo-alt"></i> {{ group.Store.Address }}</p>
                <hr />
                <h5 class="fw-bold mb-3">商品菜單</h5>
                <div class="list-group list-group-flush">
                    <div v-for="product in products" :key="product.ProductId"
                         class="list-group-item d-flex justify-content-between align-items-center bg-transparent border-0 px-0 py-3">
                        <div>
                            <h6 class="mb-0 fw-bold">{{ product.ProductName }}</h6>
                            <small class="text-muted">${{ product.Price }}</small>
                        </div>
                        <div class="d-flex align-items-center">
                            <button class="btn btn-sm btn-outline-secondary rounded-circle" @@click="updateCart(product, -1)">-</button>
                            <span class="mx-3 fw-bold">{{ getCartQty(product.ProductId) }}</span>
                            <button class="btn btn-sm btn-outline-primary rounded-circle" @@click="updateCart(product, 1)">+</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 右側：湊單進度與購物車 -->
        <div class="col-lg-4">
            <div class="premium-card p-4 sticky-top" style="top: 100px;">
                <h5 class="fw-bold mb-3">湊單進度</h5>
                <div class="mb-4">
                    <div class="progress progress-premium mb-2">
                        <div class="progress-bar progress-bar-premium" :style="{ width: progressPercent + '%' }"></div>
                    </div>
                    <div class="d-flex justify-content-between small">
                        <span>目前 ${{ group.CurrentAmount }}</span>
                        <span>目標 ${{ group.TargetAmount }}</span>
                    </div>
                </div>

                <h5 class="fw-bold mb-3">我的點餐</h5>
                <div v-if="cart.length === 0" class="text-center py-3 text-muted">
                    <small>尚未選擇商品</small>
                </div>
                <div v-else>
                    <div v-for="item in cart" :key="item.ProductId" class="d-flex justify-content-between mb-2 small">
                        <span>{{ item.ProductName }} x {{ item.Quantity }}</span>
                        <span>${{ item.Price * item.Quantity }}</span>
                    </div>
                    <hr />
                    <div class="d-flex justify-content-between fw-bold mb-4">
                        <span>小計</span>
                        <span class="text-primary">${{ cartTotal }}</span>
                    </div>
                    <button class="btn btn-premium w-100 py-3" @@click="submitOrder" :disabled="submitting">
                        {{ submitting ? '處理中...' : '確認參加湊單' }}
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>


    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    groupId: @ViewData["GroupId"],
                    group: null,
                    products: [],
                    cart: [],
                    loading: true,
                    submitting: false
                };
            },
            computed: {
                cartTotal() {
                    return this.cart.reduce((sum, item) => sum + (item.Price * item.Quantity), 0);
                },
                progressPercent() {
                    if (!this.group) return 0;
                    return Math.min(Math.round((this.group.CurrentAmount / this.group.TargetAmount) * 100), 100);
                }
            },
            methods: {
                fetchData() {
                    this.loading = true;
                    // 模擬 API 呼叫
                    setTimeout(() => {
                        this.group = {
                            GroupOrderId: this.groupId,
                            Store: {
                                StoreName: '麥當勞 台北店',
                                Phone: '02-2345-6789',
                                Address: '台北市信義區忠孝東路五段'
                            },
                            TargetAmount: 1000,
                            CurrentAmount: 650
                        };
                        this.products = [
                            { ProductId: 101, ProductName: '大麥克套餐', Price: 160 },
                            { ProductId: 102, ProductName: '勁辣雞腿堡套餐', Price: 155 },
                            { ProductId: 103, ProductName: '六塊麥克雞塊', Price: 65 },
                            { ProductId: 104, ProductName: '中杯可樂', Price: 35 }
                        ];
                        this.loading = false;
                    }, 600);
                },
                updateCart(product, delta) {
                    const item = this.cart.find(i => i.ProductId === product.ProductId);
                    if (item) {
                        item.Quantity += delta;
                        if (item.Quantity <= 0) {
                            this.cart = this.cart.filter(i => i.ProductId !== product.ProductId);
                        }
                    } else if (delta > 0) {
                        this.cart.push({ ...product, Quantity: 1 });
                    }
                },
                getCartQty(productId) {
                    const item = this.cart.find(i => i.ProductId === productId);
                    return item ? item.Quantity : 0;
                },
                submitOrder() {
                    this.submitting = true;
                    // 模擬提交
                    setTimeout(() => {
                        alert('成功加入湊單！目前總金額已更新。');
                        window.location.href = '/';
                    }, 1500);
                }
            },
            mounted() {
                this.fetchData();
            }
        }).mount('#app');
    </script>

