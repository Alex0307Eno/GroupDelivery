@{
    ViewData["Title"] = "揪IN｜附近揪團";
}

<style>
    body {
        background: linear-gradient(135deg, #f8fafc, #eef2ff);
    }

    .page-header {
        margin-bottom: 1.8rem;
    }

    .page-title {
        font-size: 1.9rem;
        font-weight: 900;
        letter-spacing: -.6px;
    }

    .page-sub {
        color: #6b7280;
        font-size: .95rem;
    }

    .section-title {
        font-size: 1.4rem;
        font-weight: 900;
        margin-bottom: .2rem;
    }

    .section-sub {
        font-size: .9rem;
        color: #6b7280;
        margin-bottom: 1.2rem;
    }

    .store-card {
        border-radius: 1.4rem;
        background: #fff;
        overflow: hidden;
        box-shadow: 0 14px 40px rgba(15,23,42,.08);
        transition: transform .25s ease, box-shadow .25s ease;
        animation: fadeUp .6s ease both;
        display: flex;
        flex-direction: column;
        height: 100%;
    }

        .store-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 28px 60px rgba(15,23,42,.18);
        }

        .store-card.urgent {
            outline: 2px solid rgba(239,68,68,.6);
        }

    .store-cover {
        height: 150px;
        background-size: cover;
        background-position: center;
        background-color: #e5e7eb;
    }

    .store-body {
        padding: 1.2rem 1.4rem 1.4rem;
        flex: 1;
        display: flex;
        flex-direction: column;
    }

    .store-name {
        font-weight: 800;
        font-size: 1.05rem;
    }

    .store-meta {
        font-size: .8rem;
        color: #6b7280;
        margin-top: .2rem;
    }

    .badge-tag {
        font-size: .7rem;
        font-weight: 800;
        padding: .3rem .6rem;
        border-radius: 999px;
        display: inline-block;
    }

    .badge-new {
        background: #8b5cf6;
        color: #fff;
    }

    .badge-urgent {
        background: #ef4444;
        color: #fff;
        animation: pulse 1.2s infinite;
    }

    .badge-active {
        background: #22c55e;
        color: #fff;
    }

    .store-cta {
        margin-top: .9rem;
        border-radius: 999px;
        font-weight: 800;
    }

    .store-footer-text {
        font-size: .8rem;
        color: #6b7280;
        margin-top: .4rem;
    }

    .empty-hint {
        font-size: .9rem;
        color: #9ca3af;
    }

    @@keyframes fadeUp {
        from {
            opacity: 0;
            transform: translateY(16px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @@keyframes pulse {
        0% {
            opacity: .4;
        }

        50% {
            opacity: 1;
        }

        100% {
            opacity: .4;
        }
    }
</style>

<div id="app" class="container py-5">

    <!-- 頁首 -->
    <div class="page-header">
        <div class="page-title">附近正在揪的店</div>
        <div class="page-sub">
            上面是正在開團的店，下方是還沒有人動手開團的店。
        </div>
    </div>

    <!-- 正在開團區塊 -->
    <div class="mb-5">
        <div class="section-title">🔥 正在開團</div>
        <div class="section-sub">
            越接近截止、越靠近你的，會排在前面。
        </div>

        <div v-if="activeStores.length === 0" class="empty-hint mb-4">
            目前附近沒有正在開團的店家，可以從下面挑一間幫他開第一團。
        </div>

        <div class="row g-4" v-if="activeStores.length > 0">
            <div class="col-lg-4 col-md-6"
                 v-for="(s, i) in activeStores"
                 :key="s.storeId"
                 :style="{ animationDelay: (i * 0.08) + 's' }">

                <div class="store-card"
                     :class="{ urgent: s.isUrgent }">

                    <div class="store-cover"
                         :style="{ backgroundImage: 'url(' + (s.coverImageUrl || '/images/store-placeholder.jpg') + ')' }">
                    </div>

                    <div class="store-body">
                        <div class="d-flex gap-2 mb-2">
                            <span v-if="s.isUrgent" class="badge-tag badge-urgent">快截止</span>
                            <span v-else-if="s.isNew" class="badge-tag badge-new">NEW</span>
                            <span class="badge-tag badge-active">開團中</span>
                        </div>

                        <div class="store-name">{{ s.storeName }}</div>
                        <div class="store-meta">
                            {{ s.openTime }} - {{ s.closeTime }} · 距離你 {{ s.distance }} 公尺
                        </div>

                        <div v-if="s.isUrgent"
                             class="text-danger fw-bold small mt-1">
                            剩 {{ s.minutesLeft }} 分鐘就截止
                        </div>

                        <a :href="'/Store/' + s.storeId + '/Groups'"
                           class="btn btn-success w-100 store-cta">
                            立刻加入這一團
                        </a>

                        <div class="store-footer-text">
                            現在加入，最容易湊到「值得送」的單。
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 尚未開團區塊 -->
    <div>
        <div class="section-title">🌱 尚未開團</div>
       

        <div class="section-sub">
            這些店附近也有人，只是還沒人開頭。你可以當第一個發起人。
        </div>

        <div class="row g-4">
            <div class="col-lg-4 col-md-6"
                 v-for="(s, i) in idleStores"
                 :key="s.storeId"
                 :style="{ animationDelay: (i * 0.05) + 's' }">

                <div class="store-card">
                    <div class="store-cover"
                         :style="{ backgroundImage: 'url(' + (s.coverImageUrl || '/images/store-placeholder.jpg') + ')' }">
                    </div>

                    <div class="store-body">
                        <div class="store-name">{{ s.storeName }}</div>
                        <div class="store-meta">
                            {{ s.openTime }} - {{ s.closeTime }} · 距離你 {{ s.distance }} 公尺
                        </div>

                        <!-- 可接單 -->
                        <a v-if="s.isAcceptingOrders"
                           :href="'/Store/' + s.storeId + '/CreateGroup'"
                           class="btn btn-outline-secondary w-100 store-cta">
                            幫這間店開一團
                        </a>

                        <!-- 暫停接單 -->
                        <button v-else
                                class="btn btn-outline-secondary w-100 store-cta"
                                disabled>
                            暫停接單中
                        </button>


                        <div class="store-footer-text">
                            只要有人跟，你就變成這一區的發起人。
                        </div>
                    </div>
                </div>
            </div>

            <div v-if="idleStores.length === 0"
                 class="empty-hint mt-3">
                這一帶目前只有正在開團的店家。
            </div>
        </div>
    </div>

</div>

<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<script>
    const { createApp } = Vue;

    createApp({
        data() {
            return {
                stores: []
            };
        },
        computed: {
            // 上半部：有正在開團的店
            activeStores() {
                return this.stores
                    .filter(function (s) { return s.hasActiveGroup; })
                    .sort(function (a, b) {
                        // 先比剩餘時間，再比距離
                        if (a.minutesLeft !== b.minutesLeft) {
                            return a.minutesLeft - b.minutesLeft;
                        }
                        return a.distance - b.distance;
                    });
            },
            // 下半部：沒有開團的店
            idleStores() {
                return this.stores
                    .filter(function (s) { return !s.hasActiveGroup; })
                    .sort(function (a, b) {
                        return a.distance - b.distance;
                    });
            }
        },
        methods: {
            enrichStore: function (store) {
                // 沒有開團就不用算 NEW / 緊急
                if (!store.hasActiveGroup) {
                    store.isUrgent = false;
                    store.isNew = false;
                    store.minutesLeft = 9999;
                    return store;
                }

                try {
                    var now = new Date();

                    var deadline = store.activeGroupDeadline
                        ? new Date(store.activeGroupDeadline)
                        : null;

                    var createdAt = store.activeGroupCreatedAt
                        ? new Date(store.activeGroupCreatedAt)
                        : null;

                    var minutesLeft = 9999;
                    if (deadline && !isNaN(deadline.getTime())) {
                        minutesLeft = Math.floor((deadline - now) / 60000);
                    }

                    var minutesSinceCreate = 9999;
                    if (createdAt && !isNaN(createdAt.getTime())) {
                        minutesSinceCreate = Math.floor((now - createdAt) / 60000);
                    }

                    store.minutesLeft = Math.max(minutesLeft, 0);
                    store.isUrgent = minutesLeft > 0 && minutesLeft <= 15;

                    store.isNew = minutesSinceCreate <= 10 && minutesSinceCreate >= 0;
                } catch (e) {
                    store.isUrgent = false;
                    store.isNew = false;
                    store.minutesLeft = 9999;
                }

                return store;
            },
            fetchStores: function () {
                var self = this;

                axios.get('/api/stores/nearby')
                    .then(function (res) {
                        var list = res.data || [];

                        self.stores = list.map(function (s) {
                            // 後端沒給的欄位先用預設值補上
                            s.coverImageUrl = s.coverImageUrl || null;
                            s.openTime = s.openTime || '尚未設定';
                            s.closeTime = s.closeTime || '';
                            return self.enrichStore(s);
                        });
                    });
            }
        },
        mounted: function () {
            this.fetchStores();
        }
    }).mount('#app');
</script>
