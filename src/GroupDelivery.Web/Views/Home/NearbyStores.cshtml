@{
    ViewData["Title"] = "揪IN｜附近揪團";
}

<style>
    body {
        background: linear-gradient(135deg, #f8fafc, #eef2ff);
    }

    .page-title {
        font-size: 1.9rem;
        font-weight: 900;
    }

    .section-title {
        font-size: 1.4rem;
        font-weight: 900;
        margin-bottom: .2rem;
    }

    .section-sub {
        font-size: .9rem;
        color: #6b7280;
        margin-bottom: 1.2rem;
    }

    .store-card {
        border-radius: 1.4rem;
        background: #fff;
        overflow: hidden;
        box-shadow: 0 14px 40px rgba(15,23,42,.08);
        transition: .25s;
        display: flex;
        flex-direction: column;
        height: 100%;
    }

        .store-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 28px 60px rgba(15,23,42,.18);
        }

        .store-card.closed {
            opacity: .5;
        }

        .store-card.urgent {
            outline: 2px solid rgba(239,68,68,.6);
        }

    .store-cover {
        height: 150px;
        background-size: cover;
        background-position: center;
        background-color: #e5e7eb;
    }

    .store-body {
        padding: 1.2rem 1.4rem 1.4rem;
        flex: 1;
    }

    .store-name {
        font-weight: 800;
        font-size: 1.05rem;
    }

    .store-meta {
        font-size: .8rem;
        color: #6b7280;
    }

    .store-hours {
        font-size: .8rem;
    }

    .btn.disabled {
        pointer-events: none;
        opacity: .6;
    }
</style>

<div id="app" class="container py-5">

    <div class="mb-4">
        <div class="page-title">附近正在揪的店</div>
        <div class="text-muted small">
            上面是正在開團的店，下方是還沒有人動手開團的店。
        </div>
    </div>

    <!-- 篩選 -->
    <div class="mb-4">
        <button class="btn btn-sm"
                :class="filterMode === 'all' ? 'btn-dark' : 'btn-outline-dark'"
                @@click="filterMode = 'all'">
            全部店家
        </button>

        <button class="btn btn-sm ms-2"
                :class="filterMode === 'open' ? 'btn-dark' : 'btn-outline-dark'"
                @@click="filterMode = 'open'">
            只看營業中
        </button>
    </div>

    <!-- 正在開團 -->
    <div class="mb-5">
        <div class="section-title">🔥 正在開團</div>
        <div class="section-sub">越接近截止越排前面</div>

        <div v-if="activeStores.length === 0" class="text-muted small">
            目前沒有正在開團的店家
        </div>

        <div class="row g-4">
            <div class="col-lg-4 col-md-6"
                 v-for="s in activeStores"
                 :key="s.storeId">

                <div class="store-card"
                     :class="{ urgent: s.isUrgent, closed: !s.isOpenNow }">

                    <div class="store-cover"
                         :style="{ backgroundImage: 'url(' + (s.coverImageUrl || '/images/store-placeholder.jpg') + ')' }">
                    </div>

                    <div class="store-body">

                        <div class="store-hours mb-2">
                            <span v-if="s.isOpenNow" class="text-success fw-bold">
                                🟢 營業中
                            </span>
                            <span v-else class="text-danger fw-bold">
                                🔴 已打烊
                            </span>
                            <span class="text-muted ms-2">
                                {{ s.businessHours }}
                            </span>
                        </div>

                        <div class="store-name">{{ s.storeName }}</div>
                        <div class="store-meta">
                            {{ s.address }} · {{ s.distance }} 公尺
                        </div>

                        <div v-if="s.isUrgent"
                             class="text-danger fw-bold small mt-1">
                            剩 {{ s.minutesLeft }} 分鐘截止
                        </div>

                        <a :href="'/Store/StoreGroups?storeId=' + s.storeId"
                           class="btn btn-success w-100 mt-3">
                            查看正在開團
                        </a>

                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 尚未開團 -->
    <div>
        <div class="section-title">🌱 尚未開團</div>
        <div class="section-sub">你可以成為發起人</div>

        <div class="row g-4">
            <div class="col-lg-4 col-md-6"
                 v-for="s in idleStores"
                 :key="s.storeId">

                <div class="store-card"
                     :class="{ closed: !s.isOpenNow }">

                    <div class="store-cover"
                         :style="{ backgroundImage: 'url(' + (s.coverImageUrl || '/images/store-placeholder.jpg') + ')' }">
                    </div>

                    <div class="store-body">

                        <div class="store-hours mb-2">
                            <span v-if="s.isOpenNow" class="text-success fw-bold">
                                🟢 營業中
                            </span>
                            <span v-else class="text-danger fw-bold">
                                🔴 已打烊
                            </span>
                            <span class="text-muted ms-2">
                                {{ s.businessHours }}
                            </span>
                        </div>

                        <div class="store-name">{{ s.storeName }}</div>
                        <div class="store-meta">
                            {{ s.address }} · {{ s.distance }} 公尺
                        </div>

                        <a :href="s.isOpenNow ? '/Store/CreateGroup?storeId=' + s.storeId : '#'"
                           class="btn w-100 mt-3"
                           :class="s.isOpenNow ? 'btn-outline-secondary' : 'btn-secondary disabled'">
                            {{ s.isOpenNow ? '幫這間店開一團' : '已打烊，無法開團' }}
                        </a>

                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<script>
    const { createApp } = Vue;

    createApp({
        data() {
            return {
                stores: [],
                filterMode: 'all'
            };
        },

        computed: {
            activeStores() {
                return this.stores
                    .filter(s => s.hasActiveGroup)
                    .filter(s => this.filterMode === 'all' || s.isOpenNow)
                    .sort((a, b) => a.minutesLeft - b.minutesLeft);
            },

            idleStores() {
                return this.stores
                    .filter(s => !s.hasActiveGroup)
                    .filter(s => this.filterMode === 'all' || s.isOpenNow);
            }
        },

        methods: {
            enrichStore(store) {

                store.isOpenNow = store.isOpenNow === true;

                if (!store.hasActiveGroup) {
                    store.isUrgent = false;
                    store.minutesLeft = 9999;
                    return store;
                }

                try {
                    var now = new Date();
                    var deadline = store.activeGroupDeadline
                        ? new Date(store.activeGroupDeadline)
                        : null;

                    var minutesLeft = 9999;
                    if (deadline && !isNaN(deadline.getTime())) {
                        minutesLeft = Math.floor((deadline - now) / 60000);
                    }

                    store.minutesLeft = Math.max(minutesLeft, 0);
                    store.isUrgent = minutesLeft > 0 && minutesLeft <= 15;

                } catch (e) {
                    store.isUrgent = false;
                    store.minutesLeft = 9999;
                }

                return store;
            },

            fetchStores() {
                axios.get('/api/stores/nearby')
                    .then(res => {
                        var list = res.data || [];
                        this.stores = list.map(s => this.enrichStore(s));
                    });
            }
        },

        mounted() {
            this.fetchStores();
        }

    }).mount('#app');
</script>