@{
    ViewData["Title"] = "揪IN｜這家正在揪的團";
}

<style>
    .group-card {
        border-radius: 1.2rem;
        background: #ffffff;
        box-shadow: 0 10px 26px rgba(15,23,42,.08);
        padding: 1.4rem;
        height: 100%;
        transition: transform .15s ease-out, box-shadow .15s ease-out;
        position: relative;
    }

        .group-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 16px 36px rgba(15,23,42,.14);
        }

    .group-title {
        font-weight: 700;
        font-size: 1.05rem;
    }

    .group-meta {
        font-size: .85rem;
        color: #6b7280;
        margin-top: .25rem;
    }

    .group-progress {
        margin-top: 1rem;
    }

    .progress {
        height: 8px;
        border-radius: 999px;
        background: #e5e7eb;
        overflow: hidden;
    }

    .progress-bar {
        background: linear-gradient(90deg, #22c55e, #16a34a);
    }

    .group-hint {
        font-size: .85rem;
        margin-top: .6rem;
        color: #374151;
        font-weight: 600;
    }

        .group-hint.hot {
            color: #ea580c;
        }

    .group-cta {
        margin-top: 1rem;
        font-size: .9rem;
        font-weight: 700;
        border-radius: 999px;
        padding: .45rem 1.1rem;
    }

    .page-title {
        font-size: 1.6rem;
        font-weight: 800;
    }

    .page-sub {
        font-size: .95rem;
        color: #6b7280;
    }
</style>

<div id="app" class="container py-5">

    <!-- 頁首 -->
    <div class="mb-4">
        <div class="page-title">
            {{ storeName }} 正在揪的團
        </div>
        <div class="page-sub mt-1">
            有些團快滿了，慢一點就只能看別團
        </div>
    </div>

    <!-- 團購列表 -->
    <div class="row g-4">

        <div v-for="group in sortedGroups"
             :key="group.groupOrderId"
             class="col-lg-4 col-md-6">

            <div class="group-card">

                <div class="group-title">
                    {{ group.remark || '揪團中' }}
                </div>

                <div class="group-meta">
                    剩 {{ remainMinutes(group.deadline) }} 分鐘 ·
                    已 {{ group.currentPeople }} / {{ group.targetPeople }} 人
                </div>

                <!-- 進度 -->
                <div class="group-progress">
                    <div class="progress">
                        <div class="progress-bar"
                             :style="{ width: percent(group) + '%' }">
                        </div>
                    </div>
                </div>

                <!-- 提示 -->
                <div class="group-hint"
                     :class="{ 'hot': isHot(group) }">
                    <span v-if="isHot(group)">
                        快滿了，可能等你
                    </span>
                    <span v-else>
                        還有人在等
                    </span>
                </div>

                <!-- CTA -->
                <a :href="'/Group/Detail/' + group.groupOrderId"
                   class="btn btn-outline-dark group-cta">
                    看這團
                </a>

            </div>
        </div>

    </div>

</div>

<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<script>
    const { createApp } = Vue;

    createApp({
        data() {
            return {
                storeName: '某某便當',
                groups: []
            };
        },
        computed: {
            sortedGroups() {
                // 快成團的排前面
                return this.groups.slice().sort((a, b) => {
                    return this.percent(b) - this.percent(a);
                });
            }
        },
        methods: {
            fetchGroups() {
                var self = this;
                axios.get('/api/store/groups')
                    .then(res => {
                        self.groups = res.data || [];
                        if (self.groups.length > 0 && self.groups[0].storeName) {
                            self.storeName = self.groups[0].storeName;
                        }
                    });
            },
            remainMinutes(deadline) {
                var diff = new Date(deadline) - new Date();
                var m = Math.floor(diff / 60000);
                return Math.max(m, 0);
            },
            percent(g) {
                return Math.min(
                    Math.round(g.currentPeople * 100 / g.targetPeople),
                    100
                );
            },
            isHot(g) {
                return this.percent(g) >= 70;
            }
        },
        mounted() {
            this.fetchGroups();
        }
    }).mount('#app');
</script>
