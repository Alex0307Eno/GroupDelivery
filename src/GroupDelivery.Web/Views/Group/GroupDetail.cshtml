@{
    ViewData["Title"] = "揪IN｜團購詳情";
    var groupId = ViewData["GroupId"]?.ToString() ?? "0";
}

<style>
    .group-container {
        max-width: 720px;
        margin: 0 auto;
    }

    .group-header {
        font-size: 1.8rem;
        font-weight: 700;
    }

    .deadline-text {
        font-size: 1rem;
        color: #6b7280;
    }

    .countdown {
        font-size: 2rem;
        font-weight: 700;
        color: #dc2626;
    }

    .progress-box {
        background: #ffffff;
        border-radius: 1rem;
        padding: 1.5rem;
        box-shadow: 0 8px 24px rgba(0,0,0,.06);
    }

    .progress-bar-bg {
        height: 12px;
        border-radius: 999px;
        background: #e5e7eb;
        overflow: hidden;
    }

    .progress-bar-fill {
        height: 100%;
        background: linear-gradient(90deg,#16a34a,#22c55e);
        transition: width .3s ease;
    }

    .join-btn {
        font-weight: 600;
        border-radius: 999px;
        padding: .9rem 1.5rem;
        font-size: 1.1rem;
    }

    .muted-note {
        font-size: .9rem;
        color: #6b7280;
    }

    .store-card {
        background: #ffffff;
        border-radius: 1rem;
        padding: 1.2rem;
        box-shadow: 0 8px 24px rgba(0,0,0,.05);
    }

    .social-box {
        background: #f0fdf4;
        border-radius: 1rem;
        padding: 1rem;
        font-weight: 600;
        color: #166534;
    }
</style>

<div id="app" class="container py-5">
    <div class="group-container">

        <div class="mb-3">
            <div class="group-header">
                {{ store.name || '正在揪團' }}
            </div>
            <div class="deadline-text">
                截止時間：{{ formatTime(deadline) }}
            </div>
        </div>

        <div class="mb-4">
            <div class="countdown">
                剩餘 {{ remainText }}
            </div>
        </div>

        <div class="social-box mb-4" v-if="joinCount > 0">
            已有 {{ joinCount }} 人參與，再差 ${{ amountLeft }} 就成團
        </div>

        <div class="progress-box mb-4">
            <div class="d-flex justify-content-between mb-2">
                <div class="fw-semibold">已達成</div>
                <div>
                    ${{ currentAmount }} / ${{ targetAmount }}
                </div>
            </div>

            <div class="progress-bar-bg">
                <div class="progress-bar-fill"
                     :style="{ width: percent + '%' }">
                </div>
            </div>

            <div class="mt-2 muted-note">
                {{ percent }}% 完成
            </div>
        </div>

        <!-- 訂購方式選擇 -->
        <div class="progress-box mb-4" v-if="remainSeconds > 0">
            <div class="fw-semibold mb-3">
                請選擇訂購方式
            </div>

            <div class="d-grid gap-2">

                <button class="btn"
                        :class="orderMode === 'menu' ? 'btn-success' : 'btn-outline-success'"
                        @@click ="orderMode = 'menu'">
                    使用電子菜單（推薦）
                </button>

                <button class="btn"
                        :class="orderMode === 'phone' ? 'btn-warning' : 'btn-outline-secondary'"
                        @@click ="orderMode = 'phone'">
                    電話聯絡店家
                </button>

            </div>
        </div>

        <!-- 電子菜單 -->
        <a v-if="remainSeconds > 0 && orderMode === 'menu'"
           :href="'/Group/Menu/' + groupId"
           class="btn btn-success w-100 join-btn">
            前往電子菜單
        </a>

        <!-- 電話模式 -->
        <div v-if="remainSeconds > 0 && orderMode === 'phone' && store.phone"
             class="mt-3">

            <div class="store-card">
                <div class="fw-semibold mb-2">店家電話</div>

                <a class="btn btn-warning w-100"
                   :href="'tel:' + store.phone">
                    撥打 {{ store.phone }}
                </a>
            </div>
        </div>

        <!-- 截止 -->
        <button v-if="remainSeconds <= 0"
                class="btn btn-secondary w-100 join-btn"
                disabled>
            已截止
        </button>

        <div class="mb-3 muted-note mt-3"
             v-if="estimatedDeliveryTime">
            預計送達時間：{{ estimatedDeliveryTime }}
        </div>

        <!-- 店家資訊（不含電話） -->
        <div class="store-card mt-4" v-if="store.name">
            <div class="fw-semibold mb-2">店家資訊</div>
            <div class="muted-note">{{ store.name }}</div>

            <div v-if="store.address"
                 class="muted-note mt-2">
                {{ store.address }}
            </div>
        </div>

        <div class="text-center mt-3 muted-note">
            成團後店家將依序出餐與配送
        </div>

    </div>
</div>

<script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<script>
    const { createApp } = Vue;

    createApp({
        data() {
            return {
                groupId: '@groupId',
                deadline: null,
                now: new Date(),
                currentAmount: 0,
                targetAmount: 0,
                joinCount: 0,
                estimatedDeliveryTime: '',
                orderMode: '',
                store: {
                    name: '',
                    phone: '',
                    address: ''
                }
            };
        },
        computed: {
            remainSeconds() {
                if (!this.deadline) return 0;
                const diff = new Date(this.deadline) - this.now;
                return Math.max(Math.floor(diff / 1000), 0);
            },
            remainText() {
                const m = Math.floor(this.remainSeconds / 60);
                const s = this.remainSeconds % 60;
                return m.toString().padStart(2,'0') + ":" +
                       s.toString().padStart(2,'0');
            },
            percent() {
                if (!this.targetAmount) return 0;
                return Math.min(
                    Math.round(this.currentAmount * 100 / this.targetAmount),
                    100
                );
            },
            amountLeft() {
                return Math.max(this.targetAmount - this.currentAmount, 0);
            }
        },
        methods: {
            fetchGroup() {
                axios.get('/api/groups/' + this.groupId)
                    .then(res => {

                        this.deadline = res.data.deadline;
                        this.currentAmount = res.data.currentAmount;
                        this.targetAmount = res.data.targetAmount;
                        this.joinCount = res.data.joinCount;
                        this.estimatedDeliveryTime = res.data.estimatedDeliveryTime;

                        this.store = res.data.store || {
                            name: '',
                            phone: '',
                            address: ''
                        };

                        if (this.percent >= 70) {
                            this.orderMode = 'menu';
                        }
                    });
            },
            formatTime(t) {
                if (!t) return '';
                return new Date(t).toLocaleString();
            }
        },
        mounted() {
            this.fetchGroup();
            setInterval(() => {
                this.now = new Date();
            }, 1000);
        }
    }).mount('#app');
</script>