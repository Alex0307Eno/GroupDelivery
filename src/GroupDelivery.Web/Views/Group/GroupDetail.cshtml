@model int
@{
    ViewData["Title"] = "æªINï½œåœ˜è³¼è©³æƒ…";
}

<style>
    body {
        background: #f4f6fb;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto;
    }

    .group-container {
        max-width: 720px;
        margin: 0 auto;
    }

    .card-soft {
        background: white;
        border-radius: 1.2rem;
        padding: 1.5rem;
        box-shadow: 0 10px 25px rgba(0,0,0,.05);
        margin-bottom: 1rem;
    }

    .hero-title {
        font-size: 1.6rem;
        font-weight: 800;
    }

    .countdown {
        font-size: 2.2rem;
        font-weight: 900;
        margin-top: 1rem;
    }

    .progress-bg {
        height: 12px;
        background: #e5e7eb;
        border-radius: 999px;
        overflow: hidden;
    }

    .progress-fill {
        height: 100%;
        transition: width .4s ease, background .4s ease;
    }

    .option-card {
        border-radius: 999px;
        padding: .9rem 1.2rem;
        border: 2px solid #e5e7eb;
        cursor: pointer;
        text-align: center;
        transition: .2s ease;
        font-weight: 600;
    }

    .option-active {
        border-color: #111827;
        background: #111827;
        color: white;
    }

    .primary-btn {
        background: #111827;
        border: none;
        border-radius: 999px;
        padding: 1rem;
        font-weight: 700;
        color: white;
    }

    .phone-box {
        background: #111827;
        color: white;
        border-radius: 1rem;
        padding: 1.5rem;
        margin-top: 1rem;
    }

        .phone-box a {
            color: #fff;
            font-weight: 700;
            text-decoration: none;
        }
</style>

<div id="app" class="container py-5">
    <div class="group-container">

        <!-- å•†å®¶è³‡è¨Š -->
        <div class="card-soft">
            <div class="hero-title">
                {{ store.name || 'æ­£åœ¨æªåœ˜' }}
            </div>
            <div class="text-muted small mt-2">
                åœ°å€ï¼š{{ store.address || 'æœªæä¾›' }}
            </div>
            <div class="text-muted small">
                å¸‚è©±ï¼š{{ store.landline || 'æœªæä¾›' }}
            </div>
            <div class="text-muted small">
                æ‰‹æ©Ÿï¼š{{ store.mobile || 'æœªæä¾›' }}
            </div>
        </div>

        <!-- å€’æ•¸ -->
        <div class="card-soft">
            <div class="text-muted small">
                æˆªæ­¢æ™‚é–“ï¼š{{ formatTime(deadline) }}
            </div>
            <div class="countdown">
                {{ remainText }}
            </div>
        </div>

        <!-- æˆåœ˜é€²åº¦ -->
        <div class="card-soft">
            <div class="d-flex justify-content-between fw-semibold mb-2">
                <div>æˆåœ˜é€²åº¦</div>
                <div>${{ currentAmount }} / ${{ targetAmount }}</div>
            </div>

            <div class="progress-bg">
                <div class="progress-fill"
                     :style="{ width: percent + '%', background: progressColor }">
                </div>
            </div>
        </div>

        <!-- è¨‚è³¼æ–¹å¼ -->
        <div class="card-soft">
            <div class="fw-semibold mb-3">é¸æ“‡è¨‚è³¼æ–¹å¼</div>

            <div class="d-grid gap-3">
                <div class="option-card"
                     :class="orderMode === 'menu' ? 'option-active' : ''"
                     @@click="orderMode = 'menu'">
                    ä½¿ç”¨é›»å­èœå–®
                </div>

                <div class="option-card"
                     :class="orderMode === 'phone' ? 'option-active' : ''"
                     @@click="orderMode = 'phone'">
                    é›»è©±é»é¤
                </div>
            </div>
        </div>

        <!-- é›»è©±æ¨¡å¼ -->
        <div v-if="orderMode === 'phone'" class="phone-box">
            <div class="mb-2">è«‹ç›´æ¥è¯çµ¡å•†å®¶ä¸‹å–®</div>

            <div v-if="store.mobile">
                ğŸ“± <a :href="'tel:' + store.mobile">{{ store.mobile }}</a>
            </div>

            <div v-if="store.landline">
                â˜ <a :href="'tel:' + store.landline">{{ store.landline }}</a>
            </div>
        </div>

        <!-- é›»å­èœå–®æŒ‰éˆ• -->
        <button v-if="orderMode === 'menu'"
                class="primary-btn w-100 mt-3"
                @@click="goMenu">
            å‰å¾€é›»å­èœå–®
        </button>

    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/vue@3.4.21/dist/vue.global.prod.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<script>
    const { createApp } = Vue;

    createApp({
        data() {
            return {
                groupOrderId: @Model,
                deadline: null,
                now: new Date(),
                orderMode: '',
                store: {},
                currentAmount: 0,
                targetAmount: 0
            };
        },

        computed: {
            remainSeconds() {
                if (!this.deadline) return 0;
                var diff = new Date(this.deadline) - this.now;
                return Math.max(Math.floor(diff / 1000), 0);
            },

            remainText() {
                var total = this.remainSeconds;
                var h = Math.floor(total / 3600);
                var m = Math.floor((total % 3600) / 60);
                var s = total % 60;
                return h + " å°æ™‚ " + m + " åˆ† " + s + " ç§’";
            },

            percent() {
                if (!this.targetAmount) return 0;
                return Math.min(Math.round(this.currentAmount * 100 / this.targetAmount), 100);
            },

            progressColor() {
                if (this.percent >= 100) return "#16a34a";
                if (this.percent >= 80) return "#2563eb";
                if (this.percent >= 40) return "#f59e0b";
                return "#9ca3af";
            }
        },

        methods: {

            fetchGroup() {
                axios.get('/api/groups/' + this.groupOrderId)
                    .then(res => {
                        this.deadline = res.data.deadline;
                        this.store = res.data.store || {};
                        this.currentAmount = res.data.currentAmount || 0;
                        this.targetAmount = res.data.targetAmount || 0;
                    });
            },

            formatTime(t) {
                if (!t) return '';
                return new Date(t).toLocaleString();
            },

            goMenu() {
                if (!this.orderMode) {
                    alert("è«‹é¸æ“‡è¨‚è³¼æ–¹å¼");
                    return;
                }

                window.location.href =
                    '/Group/Menu/' + this.groupOrderId +
                    '?source=' + this.orderMode;
            }
        },

        mounted() {
            this.fetchGroup();
            setInterval(() => {
                this.now = new Date();
            }, 1000);
        }

    }).mount('#app');
</script>